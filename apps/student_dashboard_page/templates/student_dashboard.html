<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - GatherEd</title>
    {% load static %}

    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" as="style" onload="this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"></noscript>

    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" as="style" onload="this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"></noscript>

    <link rel="stylesheet" href="{% static 'css/student_dashboard_css.css' %}">
    <link rel="stylesheet" href="{% static 'css/student_dashboard_style.css' %}">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous" defer></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>

<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-calendar-check"></i> GatherEd
            </div>
            <nav class="sidebar-nav">
                <a href="javascript:void(0);" data-url="{% url 'student_dashboard' %}?is_ajax=true" data-clean-url="{% url 'student_dashboard' %}" class="nav-item active" onclick="handleNavClick(this)">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="javascript:void(0);" data-url="{% url 'event_list' %}?is_ajax=true" data-clean-url="{% url 'event_list' %}" class="nav-item" onclick="handleNavClick(this)">
                    <i class="fas fa-calendar-alt"></i> View Events
                </a>
                <a href="javascript:void(0);" data-url="{% url 'my_events' %}?is_ajax=true" data-clean-url="{% url 'my_events' %}" class="nav-item" onclick="handleNavClick(this)">
                    <i class="fas fa-user-check"></i> My Registrations
                </a>
            </nav>
            <div class="sidebar-footer">
                <a href="{% url 'logout' %}" id="logout-btn" class="nav-item logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-nav">
                <h1 class="page-title" id="page-title">Home</h1>
                <div class="user-profile">
                    <span class="profile-name">
                        {% if user.is_authenticated %}
                            {{ user_display_name }}
                        {% else %}
                            Student
                        {% endif %}
                    </span>
                    <i class="fas fa-user-circle"></i>
                </div>
            </header>

            <div id="content-area" class="fade-container">
                {% include 'fragments/dashboard_content_student.html' %}
            </div>
        </main>
    </div>

    <script defer>
        const pageCache = {};
        const CACHE_TIMEOUT = 60000;
        let currentController = null;
        let historyStack = [{url: "{% url 'student_dashboard' %}", title: "Home", isEntry: true}];
        let currentHistoryIndex = 0;

        document.addEventListener("DOMContentLoaded", function () {
            {% if messages %}
                {% for message in messages %}
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: "{{ message.tags|default:'info' }}",
                        title: "{{ message|escapejs }}",
                        showConfirmButton: false,
                        timer: 4000,
                        background: "#1e1e1e",
                        color: "#fff",
                        iconColor: "{% if message.tags == 'success' %}limegreen{% else %}#ff4d4d{% endif %}"
                    });
                {% endfor %}
            {% endif %}

            {% if user.is_authenticated %}
                if (!sessionStorage.getItem("student_welcomed")) {
                    const fullName = "{{ user_display_name|escapejs }}";
                    const firstName = fullName.split(" ")[0] || "Student";
                    Swal.fire({
                        toast: true,
                        position: "top-end",
                        iconHtml: '<i class="fas fa-hand-sparkles" style="color:#FFC107;"></i>',
                        title: `Welcome, ${firstName}!`,
                        text: "Ready to explore new events üéâ",
                        showConfirmButton: false,
                        timer: 4000,
                        background: "linear-gradient(to right, #1e1e1e, #2a2a2a)",
                        color: "#fff",
                        icon: false,
                    });
                    sessionStorage.setItem("student_welcomed", "true");
                }
            {% endif %}

            preloadCommonStudentPages();

            // Set initial history state
            window.history.replaceState({
                index: currentHistoryIndex,
                isEntry: true
            }, "", "{% url 'student_dashboard' %}");
        });

        window.handleNavClick = function (el) {
            const url = el.dataset.url;
            const cleanUrl = el.dataset.cleanUrl;
            const title = el.textContent.trim();
            const contentArea = document.getElementById("content-area");
            const pageTitle = document.getElementById("page-title");
            const navItems = document.querySelectorAll(".sidebar-nav .nav-item");

            if (el.classList.contains("active")) return;

            navItems.forEach(item => item.classList.remove("active"));
            el.classList.add("active");
            pageTitle.textContent = title;

            const now = Date.now();
            if (pageCache[url] && now - pageCache[url].timestamp < CACHE_TIMEOUT) {
                contentArea.innerHTML = pageCache[url].html;
                fadeInContent(contentArea);

                // Add to history stack and update browser history
                currentHistoryIndex++;
                historyStack = historyStack.slice(0, currentHistoryIndex + 1);
                historyStack.push({url: cleanUrl, title: title, isEntry: false});

                window.history.pushState({
                    index: currentHistoryIndex,
                    isEntry: false
                }, "", cleanUrl);

                fetchAndCache(url, false);
                return;
            }

            contentArea.innerHTML = `
                <div class="fast-loader">
                    <div class="spinner-border text-primary" role="status"></div>
                    <span class="loading-text">Loading content...</span>
                </div>`;
            fetchAndCache(url, true, cleanUrl, title);
        };

        function fetchAndCache(url, renderImmediately = false, cleanUrl = "", title = "") {
            const contentArea = document.getElementById("content-area");

            if (currentController) currentController.aborted = true;
            const controller = new AbortController();
            currentController = controller;

            fetch(url, { cache: "no-store", signal: controller.signal })
                .then(res => {
                    if (controller.aborted || currentController !== controller) return;
                    if (!res.ok) throw new Error("Failed to fetch page");
                    return res.text();
                })
                .then(html => {
                    if (controller.aborted || currentController !== controller) return;

                    pageCache[url] = { html, timestamp: Date.now() };
                    if (renderImmediately) {
                        contentArea.classList.add("fade-out");
                        setTimeout(() => {
                            contentArea.innerHTML = html;
                            contentArea.classList.remove("fade-out");
                            fadeInContent(contentArea);
                            if (cleanUrl) {
                                // Add to history stack and update browser history
                                currentHistoryIndex++;
                                historyStack = historyStack.slice(0, currentHistoryIndex + 1);
                                historyStack.push({url: cleanUrl, title: title, isEntry: false});

                                window.history.pushState({
                                    index: currentHistoryIndex,
                                    isEntry: false
                                }, "", cleanUrl);
                            }
                        }, 150);
                    }

                    const temp = document.createElement("div");
                    temp.innerHTML = html;
                    temp.querySelectorAll("script:not([src])").forEach(s => {
                        try { eval(s.textContent); } catch (e) {}
                    });
                })
                .catch(() => {
                    if (!controller.aborted && currentController === controller) {
                        contentArea.innerHTML = `<div class="error-message">‚ö†Ô∏è Failed to load content.</div>`;
                    }
                });
        }

        function getPageNameFromUrl(url) {
            if (url.includes('event_list')) return 'view_events';
            if (url.includes('my_events')) return 'my_registrations';
            if (url.includes('student_dashboard')) return 'home';
            return 'page';
        }

        function fadeInContent(element) {
            element.style.opacity = 1;
        }

        function preloadCommonStudentPages() {
            document.querySelectorAll(".sidebar-nav .nav-item").forEach(link => {
                const url = link.dataset.url;
                if (url.includes("event_list") || url.includes("my_events")) {
                    fetch(url, { cache: "no-store" })
                        .then(res => res.text())
                        .then(html => pageCache[url] = { html, timestamp: Date.now() })
                        .catch(() => {});
                }
            });
        }

        // Handle browser back/forward navigation
        window.addEventListener('popstate', function(event) {
            if (event.state === null) {
                // No state - show logout confirmation
                showLogoutConfirmation();
                return;
            }

            const newIndex = event.state.index;

            // If going back beyond our tracked history (should be entry point)
            if (newIndex < 0) {
                showLogoutConfirmation();
                return;
            }

            // Update current index
            currentHistoryIndex = newIndex;

            // Get the history entry
            const historyEntry = historyStack[currentHistoryIndex];
            if (!historyEntry) {
                showLogoutConfirmation();
                return;
            }

            // If this is the entry point (first home page), show logout
            if (historyEntry.isEntry) {
                showLogoutConfirmation();
                return;
            }

            // Otherwise, navigate to the page in our history
            const navItems = document.querySelectorAll(".sidebar-nav .nav-item");
            let pageFound = false;

            navItems.forEach(item => {
                if (item.dataset.cleanUrl === historyEntry.url) {
                    pageFound = true;
                    // Update active state
                    document.querySelectorAll(".sidebar-nav .nav-item").forEach(i => i.classList.remove("active"));
                    item.classList.add("active");

                    // Update page title
                    const pageTitle = document.getElementById("page-title");
                    pageTitle.textContent = historyEntry.title;

                    // Load the cached content
                    const url = item.dataset.url;
                    const contentArea = document.getElementById("content-area");

                    if (pageCache[url]) {
                        contentArea.innerHTML = pageCache[url].html;
                        fadeInContent(contentArea);
                    } else {
                        fetchAndCache(url, true, item.dataset.cleanUrl, historyEntry.title);
                    }
                }
            });

            // If page not found (shouldn't happen), go to home
            if (!pageFound) {
                // Fall back to home
                const homeItem = document.querySelector('.nav-item[data-clean-url="{% url 'student_dashboard' %}"]');
                if (homeItem) {
                    homeItem.click();
                }
            }
        });

        function showLogoutConfirmation() {
            Swal.fire({
                title: "Do you want to log out?",
                text: "You'll need to log in again to access the student dashboard.",
                icon: "question",
                background: "#1e1e1e",
                color: "#fff",
                showCancelButton: true,
                confirmButtonColor: "#007bff",
                cancelButtonColor: "#6c757d",
                confirmButtonText: '<i class="fas fa-sign-out-alt"></i> Log out',
                cancelButtonText: "Stay here",
            }).then(result => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: "Logging out...",
                        background: "#1e1e1e",
                        color: "#fff",
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                            setTimeout(() => (window.location.href = "{% url 'logout' %}"), 600);
                        },
                    });
                } else {
                    // User chose to stay, push the current state back
                    window.history.pushState({
                        index: currentHistoryIndex,
                        isEntry: currentHistoryIndex === 0
                    }, "", historyStack[currentHistoryIndex].url);
                }
            });
        }

        // ‚úÖ Logout Confirmation (Click)
        document.addEventListener("DOMContentLoaded", () => {
            const logoutBtn = document.getElementById("logout-btn");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", function (e) {
                    e.preventDefault();
                    const logoutUrl = this.href;
                    Swal.fire({
                        title: "Log out from GatherEd?",
                        text: "You will need to log in again to access your student dashboard.",
                        icon: "question",
                        background: "#1e1e1e",
                        color: "#fff",
                        showCancelButton: true,
                        confirmButtonColor: "#007bff",
                        cancelButtonColor: "#6c757d",
                        confirmButtonText: '<i class="fas fa-sign-out-alt"></i> Log out',
                        cancelButtonText: "Cancel",
                    }).then(result => {
                        if (result.isConfirmed) {
                            Swal.fire({
                                title: "Logging out...",
                                background: "#1e1e1e",
                                color: "#fff",
                                allowOutsideClick: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                    setTimeout(() => (window.location.href = logoutUrl), 600);
                                },
                            });
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>