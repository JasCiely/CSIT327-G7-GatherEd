{% load static %}
<link rel="stylesheet" href="{% static 'css/event_list_style.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="full-width-card student-events-container">
    {% csrf_token %}
    <div class="card-header">
        <div>
            <h2>Available Events</h2>
            <p class="card-subtitle">Browse and register for upcoming events organized by your school or organization.</p>
        </div>
    </div>

    <div class="events-controls">
        <input id="search" type="text" placeholder="Search events by name..." class="control-input" onkeyup="filterEventCards()">
        <select id="statusFilter" class="control-select" onchange="filterEventCards()">
            <option value="all">All Events</option>
            <option value="available">Available</option>
            <option value="registered">Registered</option>
            <option value="full">Full</option>
        </select>
        <button id="refreshEventsBtn" class="btn-refresh" onclick="refreshEventList()">
            <i class="fas fa-sync-alt"></i> Refresh List
        </button>
    </div>

    <div class="events-content-wrapper">
        <div class="events-list-area">
            {% if events_list %}
            <div id="eventsCardGrid" class="events-card-grid">
                {% for event in events_list %}
                {% with status_lower=event.status|lower %}

                <div class="event-card event-expand-card"
                     data-event-id="{{ event.id }}"
                     data-status="{{ status_lower }}"
                     data-name="{{ event.name|lower }}"
                     data-date="{{ event.date }}"
                     data-time="{{ event.time }}"
                     data-location="{{ event.location }}"
                     data-organization="{{ event.organization_name }}"
                     data-capacity="{{ event.attendee_count|default:'?' }}/{{ event.capacity|default:'Max' }}">

                    <div class="card-image-wrapper">
                        <img src="{% if event.image_url %}{{ event.image_url }}{% else %}https://placehold.co/700x200/121212/00A9FF?text=Event+Image{% endif %}" alt="{{ event.name }}" id="event-img-{{ event.id }}">

                        <div class="card-badges">
                            <span class="card-badge badge-{{ status_lower }}">{{ event.status }}</span>
                            <span class="card-badge badge-capacity">
                                <i class="fas fa-users" style="margin-right: 4px;"></i>
                                {{ event.attendee_count|default:"?" }}/{{ event.capacity|default:"Max" }}
                            </span>
                        </div>
                    </div>

                    <div class="card-content">
                        <p class="card-datetime">
                            <i class="fas fa-clock"></i>
                            {{ event.date }} {{ event.time }}
                        </p>
                        <h3 class="card-title">{{ event.name }}</h3>

                        {% if event.location %}
                        <p class="card-location">
                            <i class="fas fa-map-marker-alt"></i>
                            {{ event.location }}
                        </p>
                        {% endif %}

                        {% if event.organization_name %}
                        <p class="card-organization">
                            <i class="fas fa-school"></i>
                            {{ event.organization_name }}
                        </p>
                        {% endif %}

                        <div class="card-expand-area">
                            <p class="card-description" id="short-desc-{{ event.id }}">{{ event.short_description }}</p>
                        </div>


                        <div class="card-actions">
                            <button class="btn-details-toggle">
                                <i class="fas fa-info-circle"></i> See Details
                            </button>
                            <button class="btn btn-primary btn-sm"
                                    onclick="registerForEvent({{ event.id }}); event.stopPropagation();">
                                <i class="fas fa-user-plus"></i> Register
                            </button>
                        </div>
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
            <div id="noResultsMessage" class="no-results-message" style="display: none;"></div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-calendar-times"></i>
                <p>No events are currently available.</p>
                <p class="muted">Please check back later for new opportunities.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div id="eventDetailsModal" class="event-modal-backdrop">
    <div class="event-modal-content">
        <button class="modal-close-btn" onclick="hideEventModal()"><i class="fas fa-times"></i></button>

        <img src="https://placehold.co/700x200/121212/00A9FF?text=Event+Image" alt="Event Image" class="modal-image" id="modal-event-image">

        <div class="modal-body">
            <div class="modal-header">
                <h3 id="modal-event-title"></h3>
            </div>

            <div class="modal-details">
                <p class="modal-detail-row"><i class="fas fa-clock"></i> <span id="modal-event-datetime"></span></p>
                <p class="modal-detail-row"><i class="fas fa-map-marker-alt"></i> <span id="modal-event-location"></span></p>
                <p class="modal-detail-row"><i class="fas fa-school"></i> <span id="modal-event-organization"></span></p>
                <p class="modal-detail-row"><i class="fas fa-users"></i> <span id="modal-event-capacity"></span></p>
            </div>

            <div class="modal-full-description">
                <h4>Event Description</h4>
                <p id="modal-event-description"></p>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-primary" id="modal-register-btn" onclick="registerForEventFromModal();">
                <i class="fas fa-user-plus"></i> Register for Event
            </button>
        </div>
    </div>
</div>


<script>
    let currentModalEventId = null;

    function showLoadingModal(message) {
        $('#custom-loading-modal').remove();
        const modalHtml = `
            <div id="custom-loading-modal" class="custom-modal-backdrop" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:flex; justify-content:center; align-items:center; z-index:10000; color:white;">
                <div class="custom-modal-content loading-modal-style">
                    <h3>${message}</h3>
                    <i class="fas fa-sync-alt fa-spin loading-spinner"></i>
                </div>
            </div>`;
        $('body').append(modalHtml);
    }
    function hideLoadingModal() {
        $('#custom-loading-modal').remove();
    }

    function refreshEventList() {
        showLoadingModal('Refreshing Event List...');

        $.ajax({
            url: "{% url 'event_list' %}?is_ajax=true", // Use query param for AJAX flag
            method: 'GET',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(data) {
                // Assuming data is the full HTML fragment for the content area
                const $newContent = $(data);

                // If the AJAX view returns the fragment directly
                if ($newContent.hasClass('events-list-area') || $newContent.find('.events-list-area').length === 0) {
                     $('.events-list-area').html(data);
                } else {
                    // If the view returned the full dashboard, extract the needed part
                    const $extractedContent = $newContent.find('.events-list-area').html();
                    if ($extractedContent) {
                         $('.events-list-area').html($extractedContent);
                    }
                }

                hideLoadingModal();
                filterEventCards();
            },
            error: function(xhr) {
                hideLoadingModal();
                alert(`Error refreshing list: ${xhr.status} ${xhr.statusText}`);
            }
        });
    }

    let currentSearchTerm = '';
    let currentStatusFilter = 'all';

    function filterEventCards() {
        // FIX: Defensive coding for toLowerCase on search term
        currentSearchTerm = ($('#search').val() || '').toLowerCase().trim();
        currentStatusFilter = $('#statusFilter').val();

        const $grid = $('#eventsCardGrid');
        if ($grid.length === 0 && $('.event-card').length === 0) {
            $('#noResultsMessage').hide(); // If truly empty state, let empty-state block show
            return;
        }

        const $cards = $grid.find('.event-expand-card');
        let visibleCount = 0;

        $cards.each(function() {
            const $card = $(this);
            // FIX: Guard against undefined data attributes (resolves console error)
            const nameText = String($card.data('name') || '').toLowerCase();
            const status = String($card.data('status') || '');

            const matchesSearch = nameText.includes(currentSearchTerm);
            let matchesStatus = (currentStatusFilter === 'all') || (status === currentStatusFilter);

            if (matchesSearch && matchesStatus) {
                $card.show();
                visibleCount++;
            } else {
                $card.hide();
            }
        });

        const $messageContainer = $('#noResultsMessage');

        if (visibleCount === 0 && ($cards.length > 0)) {
            $grid.hide();
            $messageContainer.text("No events found matching your current filters.").show();
        } else if (visibleCount > 0) {
            $grid.show();
            $messageContainer.hide();
        }
    }

    function showEventModal(eventId) {
        const $card = $(`[data-event-id="${eventId}"]`);

        if ($card.length === 0) {
            console.error(`Event card not found for ID: ${eventId}`);
            return;
        }

        currentModalEventId = eventId;

        // 1. Populate static details from the card
        const eventName = $card.find('.card-title').text();
        const status = $card.data('status');
        const cardImageUrl = $card.find('.card-image-wrapper img').attr('src');

        $('#modal-event-title').text(eventName);
        $('#modal-event-datetime').text(`${$card.data('date')} ${$card.data('time')}`);
        $('#modal-event-location').text($card.data('location') || 'Not specified');
        $('#modal-event-organization').text($card.data('organization') || 'N/A');
        $('#modal-event-capacity').text($card.data('capacity'));
        $('#modal-event-image').attr('src', cardImageUrl);

        // Initial loading state for description
        $('#modal-event-description').html('<i class="fas fa-spinner fa-spin"></i> Loading full description...');

        // 2. Fetch the full description via AJAX
        $.ajax({
            url: `{% url 'event_details' 0 %}`.replace('0', eventId),
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                $('#modal-event-description').text(data.full_description || 'No detailed description available.');

                // Update Register button based on initial card status
                const $registerBtn = $('#modal-register-btn');
                $registerBtn.off('click').on('click', registerForEventFromModal);

                // Use the status from the card (which is fresh from Django view)
                if (status === 'full') {
                    $registerBtn.text('Event Full').prop('disabled', true).removeClass('btn-primary').addClass('btn-secondary');
                } else if (status === 'registered') {
                    $registerBtn.text('Already Registered').prop('disabled', true).removeClass('btn-primary').addClass('btn-secondary');
                } else {
                    $registerBtn.text('Register for Event').prop('disabled', false).removeClass('btn-secondary').addClass('btn-primary');
                }
            },
            error: function(xhr, status, error) {
                console.error("Error fetching event details:", error);
                $('#modal-event-description').html('Error loading detailed description.');
                $('#modal-register-btn').text('Cannot Register (Error)').prop('disabled', true).removeClass('btn-primary').addClass('btn-danger');
            }
        });

        // 3. Show the modal
        const $modal = $('#eventDetailsModal');
        $modal.css('display', 'flex').hide().fadeIn(200);
        $('body').addClass('modal-open');
    }

    function hideEventModal() {
        $('#eventDetailsModal').fadeOut(200, function() {
            $(this).css('display', 'none');
        });
        $('body').removeClass('modal-open');
        currentModalEventId = null;
    }

    function registerForEvent(eventId) {
        showLoadingModal('Registering...');

        const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
        if (!csrfToken) {
            hideLoadingModal();
            alert('Security Error: CSRF token missing. Please refresh the page.');
            return;
        }

        $.ajax({
            url: `{% url 'register_event' 0 %}`.replace('0', eventId),
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            dataType: 'json',
            success: function(response) {
                hideLoadingModal();
                alert(`Success: ${response.message}`);
                // Refresh list to update status badge on card
                refreshEventList();
                if (currentModalEventId === eventId) {
                    showEventModal(eventId); // Re-open to update button state
                }
            },
            error: function(xhr) {
                hideLoadingModal();
                let errorMessage = "Registration failed. Please try again.";

                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 401) {
                    errorMessage = "You must be logged in to register for events.";
                } else if (xhr.status === 403) {
                    errorMessage = "Forbidden: Session expired or invalid security token. Please refresh the page.";
                } else if (xhr.status === 400) {
                    errorMessage = "Bad Request: Unable to register. Event might be full or you're already registered.";
                }

                alert(`Error: ${errorMessage}`);
            }
        });
    }

    function registerForEventFromModal() {
        if (currentModalEventId) {
            // Register function handles showing loading and errors
            registerForEvent(currentModalEventId);
        }
    }


    $(document).ready(function() {
        window.refreshEventList = refreshEventList;
        window.filterEventCards = filterEventCards;
        window.registerForEvent = registerForEvent;
        window.showEventModal = showEventModal;
        window.hideEventModal = hideEventModal;
        window.registerForEventFromModal = registerForEventFromModal;

        filterEventCards();

        // 1. Event Delegation for 'See Details' button
        $(document).on('click', '.btn-details-toggle', function(e) {
            e.preventDefault();
            e.stopPropagation();

            const eventId = $(this).closest('.event-card').data('event-id');
            if (eventId) {
                showEventModal(eventId);
            }
        });

        // 2. Event Delegation for clicking the entire event card
        $(document).on('click', '.event-card', function(e) {
            // Ensure click did not originate from one of the action buttons
            if ($(e.target).closest('.btn-primary, .btn-secondary, .btn-details-toggle').length) {
                return;
            }

            const eventId = $(this).data('event-id');
            if (eventId) {
                showEventModal(eventId);
            }
        });

        // Close modal when clicking the backdrop
        $('#eventDetailsModal').on('click', function(e) {
            if (e.target === this) {
                hideEventModal();
            }
        });
    });
</script>