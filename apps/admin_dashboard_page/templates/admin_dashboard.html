<!-- apps/admin_dashboard_page/templates/admin_dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - GatherEd</title>
    {% load static %}

    <!-- ✅ Optimized CSS Loading -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" as="style" onload="this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"></noscript>

    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" as="style" onload="this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"></noscript>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/admin_dashboard_css.css' %}">

    <!-- ✅ Deferred Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous" defer></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11" defer></script>

    <!-- Removed meta refresh (was slowing load) -->
</head>

<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-calendar-check"></i> GatherEd
            </div>
            <nav class="sidebar-nav">
                <a href="javascript:void(0);" data-url="{% url 'admin_dashboard' %}?is_ajax=true" data-clean-url="{% url 'admin_dashboard' %}" class="nav-item active" onclick="handleNavClick(this)">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="javascript:void(0);" data-url="{% url 'manage_event' %}?is_ajax=true" data-clean-url="{% url 'manage_event' %}" class="nav-item" onclick="handleNavClick(this)">
                    <i class="fas fa-calendar-alt"></i> View/Modify Events
                </a>
                <a href="javascript:void(0);" data-url="{% url 'create_event' %}?is_ajax=true" data-clean-url="{% url 'create_event' %}" class="nav-item" onclick="handleNavClick(this)">
                    <i class="fas fa-plus-circle"></i> Create New Event
                </a>
                <a href="javascript:void(0);" data-url="{% url 'track_attendance' %}?is_ajax=true" data-clean-url="{% url 'track_attendance' %}" class="nav-item" onclick="handleNavClick(this)">
                    <i class="fas fa-user-check"></i> Track Attendance
                </a>
                <a href="javascript:void(0);" data-url="{% url 'manage_feedback' %}?is_ajax=true" data-clean-url="{% url 'manage_feedback' %}" class="nav-item" onclick="handleNavClick(this)">
                    <i class="fas fa-comments"></i> View Feedback
                </a>
            </nav>

            <div class="sidebar-footer">
                <a href="{% url 'logout' %}" id="logout-btn" class="nav-item logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-nav">
                <h1 class="page-title" id="page-title">Dashboard Overview</h1>
                <div class="header-actions">
                    <div class="notification-icon" onclick="toggleNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="badge" id="notification-count">{{ notification_count }}</span>
                    </div>
                    <div class="user-profile">
                        {% if request.user.is_authenticated %}
                            <span class="profile-name">{{ request.user.adminprofile.name|default:'Administrator' }}</span>
                        {% else %}
                            <span class="profile-name">Guest Admin</span>
                        {% endif %}
                        <i class="fas fa-user-circle"></i>
                    </div>
                </div>
            </header>

            <div id="content-area" class="fade-container">
                {% include 'fragments/dashboard_content.html' %}
            </div>
        </main>
    </div>

    <div id="notification-drawer" class="notification-drawer">
        <h3>Notifications</h3>
        <div id="notification-list">
            <p style="color: var(--text-muted);">Notifications will load here from the backend.</p>
        </div>
    </div>

    <script defer>
        document.addEventListener("DOMContentLoaded", function () {
            {% if messages %}
                {% for message in messages %}
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: "{{ message.tags|default:'info' }}",
                        title: "{{ message|escapejs }}",
                        showConfirmButton: false,
                        timer: 4000,
                        timerProgressBar: true,
                        background: "#1e1e1e",
                        color: "#fff",
                        iconColor: "{% if message.tags == 'success' %}limegreen{% else %}#ff4d4d{% endif %}"
                    });
                {% endfor %}
            {% endif %}

            {% if request.user.is_authenticated %}
                if (!sessionStorage.getItem("welcomed")) {
                    const fullName = "{{ request.user.adminprofile.name|default:request.user.username|escapejs }}";
                    const firstName = fullName.split(" ")[0] || "Admin";
                    Swal.fire({
                        toast: true,
                        position: "top-end",
                        iconHtml: '<i class="fas fa-hand-sparkles" style="color:#FFC107;"></i>',
                        title: `Welcome back, ${firstName}!`,
                        text: "Ready to organize amazing school events! 🚀",
                        showConfirmButton: false,
                        timer: 4000,
                        background: "linear-gradient(to right, #1e1e1e, #2a2a2a)",
                        color: "#fff",
                        icon: false,
                    });
                    sessionStorage.setItem("welcomed", "true");
                }
            {% endif %}

            preloadCommonPages();
        });

        // =======================================
        // 🚀 Optimized Fast Navigation
        // =======================================
        const pageCache = {};
        const CACHE_TIMEOUT = 60000; // 1 minute
        let currentController = null;

        window.handleNavClick = function (el) {
            const url = el.dataset.url;
            const cleanUrl = el.dataset.cleanUrl;
            const title = el.textContent.trim();
            const contentArea = document.getElementById("content-area");
            const pageTitle = document.getElementById("page-title");
            const navItems = document.querySelectorAll(".sidebar-nav .nav-item");

            navItems.forEach(item => item.classList.remove("active"));
            el.classList.add("active");
            pageTitle.textContent = title;

            const now = Date.now();
            if (pageCache[url] && now - pageCache[url].timestamp < CACHE_TIMEOUT) {
                contentArea.innerHTML = pageCache[url].html;
                fadeInContent(contentArea);
                history.pushState(null, "", cleanUrl);
                fetchAndCache(url, false);
                return;
            }

            contentArea.innerHTML = `
                <div class="fast-loader">
                    <div class="spinner-border text-primary" role="status"></div>
                    <span class="loading-text">Loading content...</span>
                </div>`;
            fetchAndCache(url, true, cleanUrl);
        };

        function fetchAndCache(url, renderImmediately = false, cleanUrl = "") {
            const contentArea = document.getElementById("content-area");

            if (currentController) currentController.aborted = true;
            const controller = new AbortController();
            currentController = controller;

            fetch(url, { cache: "no-store", signal: controller.signal })
                .then(res => {
                    if (controller.aborted || currentController !== controller) return;
                    if (!res.ok) throw new Error("Failed to fetch page");
                    return res.text();
                })
                .then(html => {
                    if (controller.aborted || currentController !== controller) return;

                    pageCache[url] = { html, timestamp: Date.now() };
                    if (renderImmediately) {
                        contentArea.classList.add("fade-out");
                        setTimeout(() => {
                            contentArea.innerHTML = html;
                            contentArea.classList.remove("fade-out");
                            fadeInContent(contentArea);
                            if (cleanUrl) history.pushState(null, "", cleanUrl);
                        }, 150);
                    }

                    // Re-run inline scripts only (skip external)
                    const temp = document.createElement("div");
                    temp.innerHTML = html;
                    temp.querySelectorAll("script:not([src])").forEach(s => {
                        try { eval(s.textContent); } catch (e) {}
                    });
                })
                .catch(() => {
                    if (!controller.aborted && currentController === controller) {
                        contentArea.innerHTML = `<div class="error-message">⚠️ Failed to load content.</div>`;
                    }
                });
        }

        // =======================================
        // 💨 Fade-In Effect via CSS
        // =======================================
        function fadeInContent(element) {
            element.style.opacity = 1;
        }

        // =======================================
        // ⚙️ Preload Common Pages
        // =======================================
        function preloadCommonPages() {
            document.querySelectorAll(".sidebar-nav .nav-item").forEach(link => {
                const url = link.dataset.url;
                if (url.includes("create_event") || url.includes("manage_event") || url.includes("track_attendance")) {
                    fetch(url, { cache: "no-store" })
                        .then(res => res.text())
                        .then(html => pageCache[url] = { html, timestamp: Date.now() })
                        .catch(() => {});
                }
            });
        }

        // =======================================
        // 🔔 Notifications Drawer
        // =======================================
        window.toggleNotifications = function () {
            const drawer = document.getElementById("notification-drawer");
            const badge = document.getElementById("notification-count");
            drawer.classList.toggle("open");
            const count = parseInt(badge.textContent || "0");
            badge.style.display = drawer.classList.contains("open") ? "none" : (count > 0 ? "block" : "none");
        };

        // =======================================
        // 🚪 Logout Confirmation
        // =======================================
        document.addEventListener("DOMContentLoaded", () => {
            const logoutBtn = document.getElementById("logout-btn");
            if (logoutBtn) {
                logoutBtn.addEventListener("click", function (e) {
                    e.preventDefault();
                    const logoutUrl = this.href;
                    Swal.fire({
                        title: "Log out from GatherEd?",
                        text: "You will need to log in again to access the dashboard.",
                        icon: "question",
                        background: "#1e1e1e",
                        color: "#fff",
                        showCancelButton: true,
                        confirmButtonColor: "#007bff",
                        cancelButtonColor: "#6c757d",
                        confirmButtonText: '<i class="fas fa-sign-out-alt"></i> Log out',
                        cancelButtonText: "Cancel",
                    }).then(result => {
                        if (result.isConfirmed) {
                            Swal.fire({
                                title: "Logging out...",
                                background: "#1e1e1e",
                                color: "#fff",
                                allowOutsideClick: false,
                                didOpen: () => {
                                    Swal.showLoading();
                                    setTimeout(() => (window.location.href = logoutUrl), 600);
                                },
                            });
                        }
                    });
                });
            }
        });

        // =======================================
        // 🧠 Prevent Back Cache Navigation
        // =======================================
        if (window.history && window.history.pushState) {
            window.history.pushState(null, null, window.location.href);
            window.onpopstate = function () {
                window.history.pushState(null, null, window.location.href);
            };
        }

        // =======================================
        // ✅ Auto Refresh Upcoming Events
        // =======================================
        document.addEventListener("DOMContentLoaded", function () {
            const refreshInterval = 60000;
            setInterval(async () => {
                if (document.hidden) return; // Skip if tab inactive
                const section = document.getElementById("upcoming-events-section");
                if (!section) return;
                const activeNav = document.querySelector(".sidebar-nav .nav-item.active");
                if (!activeNav || !activeNav.textContent.includes("Dashboard")) return;
                try {
                    const response = await fetch("{% url 'admin_dashboard' %}?is_ajax=true", { cache: "no-store" });
                    if (!response.ok) throw new Error();
                    const html = await response.text();
                    const temp = document.createElement("div");
                    temp.innerHTML = html;
                    const newSection = temp.querySelector("#upcoming-events-section");
                    if (newSection) section.innerHTML = newSection.innerHTML;
                } catch {}
            }, refreshInterval);
        });
    </script>

    <!-- ✅ Small CSS helper for fade -->
    <style>
        .fade-container {
            transition: opacity 0.25s ease-in;
            opacity: 1;
        }
        .fade-container.fade-out {
            opacity: 0;
        }
    </style>
</body>
</html>