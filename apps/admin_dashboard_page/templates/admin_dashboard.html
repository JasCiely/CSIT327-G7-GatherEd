<!-- apps/admin_dashboard_page/templates/admin_dashboard.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - GatherEd</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/admin_dashboard_css.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>

<body>
    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-calendar-check"></i> GatherEd
            </div>
            <nav class="sidebar-nav">
                <a href="javascript:void(0);" data-url="{% url 'admin_dashboard' %}?is_ajax=true" data-clean-url="{% url 'admin_dashboard' %}" class="nav-item active" onclick="handleNavClick(this)">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="javascript:void(0);" data-url="{% url 'manage_event' %}?is_ajax=true" data-clean-url="{% url 'manage_event' %}" class="nav-item" onclick="handleNavClick(this)">
                    <i class="fas fa-calendar-alt"></i> View/Modify Events
                </a>
                <a href="javascript:void(0);" data-url="{% url 'create_event' %}?is_ajax=true" data-clean-url="{% url 'create_event' %}" class="nav-item" onclick="handleNavClick(this)">
                    <i class="fas fa-plus-circle"></i> Create New Event
                </a>
                <a href="javascript:void(0);" data-url="{% url 'track_attendance' %}?is_ajax=true" data-clean-url="{% url 'track_attendance' %}" class="nav-item" onclick="handleNavClick(this)">
                    <i class="fas fa-user-check"></i> Track Attendance
                </a>
                <a href="javascript:void(0);" data-url="{% url 'manage_feedback' %}?is_ajax=true" data-clean-url="{% url 'manage_feedback' %}" class="nav-item" onclick="handleNavClick(this)">
                    <i class="fas fa-comments"></i> View Feedback
                </a>
            </nav>

            <div class="sidebar-footer">
                <a href="{% url 'logout' %}" id="logout-btn" class="nav-item logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </aside>

        <main class="main-content">
            <header class="top-nav">
                <h1 class="page-title" id="page-title">Dashboard Overview</h1>
                <div class="header-actions">
                    <div class="notification-icon" onclick="toggleNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="badge" id="notification-count">{{ notification_count }}</span>
                    </div>
                    <div class="user-profile">
                        {% if request.user.is_authenticated %}
                            <span class="profile-name">
                                {{ request.user.adminprofile.name|default:'Administrator' }}
                            </span>
                        {% else %}
                            <span class="profile-name">Guest Admin</span>
                        {% endif %}
                        <i class="fas fa-user-circle"></i>
                    </div>
                </div>
            </header>

            <div id="content-area">
                {% include 'fragments/dashboard_content.html' %}
            </div>
        </main>
    </div>

    <div id="notification-drawer" class="notification-drawer">
        <h3>Notifications</h3>
        <div id="notification-list">
            <p style="color: var(--text-muted);">Notifications will load here from the backend.</p>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            {% if messages %}
                {% for message in messages %}
                    Swal.fire({
                        toast: true,
                        position: 'top-end',
                        icon: "{{ message.tags|default:'info' }}",
                        title: "{{ message|escapejs }}",
                        showConfirmButton: false,
                        timer: 4000,
                        timerProgressBar: true,
                        background: "#1e1e1e",
                        color: "#fff",
                        iconColor: "{% if message.tags == 'success' %}limegreen{% else %}#ff4d4d{% endif %}"
                    });
                {% endfor %}
            {% endif %}

            // 👋 Welcome message once per session
            {% if request.user.is_authenticated %}
                if (!sessionStorage.getItem("welcomed")) {
                    const fullName = "{{ request.user.adminprofile.name|default:request.user.username|escapejs }}";
                    const firstName = fullName.split(" ")[0] || "Admin";
                    Swal.fire({
                        toast: true,
                        position: "top-end",
                        iconHtml: '<i class="fas fa-hand-sparkles" style="color:#FFC107;"></i>',
                        title: `Welcome back, ${firstName}!`,
                        text: "Ready to organize amazing school events! 🚀",
                        showConfirmButton: false,
                        timer: 4000,
                        background: "linear-gradient(to right, #1e1e1e, #2a2a2a)",
                        color: "#fff",
                        icon: false,
                    });
                    sessionStorage.setItem("welcomed", "true");
                }
            {% endif %}

            preloadCommonPages();
        });

        // =======================================
        // ⚡ FAST, SAFE CACHED NAVIGATION SYSTEM
        // =======================================
        const pageCache = {};
        const CACHE_TIMEOUT = 15000; // 15 seconds
        let currentController = null; // track the active request controller

        window.handleNavClick = function (el) {
            const url = el.getAttribute("data-url");
            const cleanUrl = el.getAttribute("data-clean-url");
            const title = el.textContent.trim();
            const contentArea = document.getElementById("content-area");
            const pageTitle = document.getElementById("page-title");
            const navItems = document.querySelectorAll(".sidebar-nav .nav-item");

            navItems.forEach(item => item.classList.remove("active"));
            el.classList.add("active");
            pageTitle.textContent = title;

            const now = Date.now();
            if (pageCache[url] && now - pageCache[url].timestamp < CACHE_TIMEOUT) {
                contentArea.innerHTML = pageCache[url].html;
                fadeInContent(contentArea);
                history.pushState(null, "", cleanUrl);
                // update silently in background
                fetchAndCache(url, false);
                return;
            }

            contentArea.innerHTML = `
                <div class="fast-loader">
                    <div class="spinner-border text-primary" role="status"></div>
                    <span class="loading-text">Loading content...</span>
                </div>
            `;
            fetchAndCache(url, true, cleanUrl);
        };

        function fetchAndCache(url, renderImmediately = false, cleanUrl = "") {
            const contentArea = document.getElementById("content-area");

            if (currentController) {
                currentController.aborted = true;
            }

            const controller = new AbortController();
            currentController = controller;

            fetch(url, { cache: "no-store", signal: controller.signal })
                .then(res => {
                    // skip if newer request started
                    if (controller.aborted || currentController !== controller) return;
                    if (!res.ok) throw new Error("Failed to fetch page");
                    return res.text();
                })
                .then(html => {
                    if (controller.aborted || currentController !== controller) return;

                    // Cache the page
                    pageCache[url] = { html, timestamp: Date.now() };
                    if (renderImmediately) {
                        contentArea.innerHTML = html;
                        fadeInContent(contentArea);
                        if (cleanUrl) history.pushState(null, "", cleanUrl);
                    }

                    // Re-run scripts properly
                    const temp = document.createElement("div");
                    temp.innerHTML = html;
                    temp.querySelectorAll("script").forEach(s => {
                        const ns = document.createElement("script");
                        if (s.src) ns.src = s.src;
                        else ns.textContent = s.textContent;
                        document.body.appendChild(ns);
                    });
                })
                .catch(err => {
                    // only show if not user-aborted
                    if (!controller.aborted && currentController === controller) {
                        contentArea.innerHTML = `<div class="error-message">⚠️ Failed to load content.</div>`;
                    }
                });
        }

        // =======================================
        // 💨 FADE-IN ANIMATION
        // =======================================
        function fadeInContent(element) {
            element.style.opacity = 0;
            element.style.transition = "opacity 0.25s ease-in";
            requestAnimationFrame(() => {
                element.style.opacity = 1;
            });
        }

        // =======================================
        // ⚙️ PRELOAD COMMON PAGES
        // =======================================
        function preloadCommonPages() {
            const preloadLinks = document.querySelectorAll(".sidebar-nav .nav-item");
            preloadLinks.forEach(link => {
                const url = link.getAttribute("data-url");
                // only preload main pages
                if (url.includes("create_event") || url.includes("manage_event") || url.includes("track_attendance")) {
                    fetch(url, { cache: "no-store" })
                        .then(res => res.text())
                        .then(html => {
                            pageCache[url] = { html, timestamp: Date.now() };
                        })
                        .catch(() => {});
                }
            });
        }

        // =======================================
        // 🔔 NOTIFICATIONS DRAWER
        // =======================================
        window.toggleNotifications = function () {
            const drawer = document.getElementById("notification-drawer");
            const badge = document.getElementById("notification-count");
            drawer.classList.toggle("open");
            const count = parseInt(badge.textContent || "0");
            badge.style.display = drawer.classList.contains("open") ? "none" : (count > 0 ? "block" : "none");
        };

        // =======================================
        // 🚪 LOGOUT CONFIRMATION
        // =======================================
        document.getElementById("logout-btn").addEventListener("click", function (e) {
            e.preventDefault();
            const logoutUrl = this.href;
            Swal.fire({
                title: "Log out from GatherEd?",
                text: "You will need to log in again to access the dashboard.",
                icon: "question",
                background: "#1e1e1e",
                color: "#fff",
                showCancelButton: true,
                confirmButtonColor: "#007bff",
                cancelButtonColor: "#6c757d",
                confirmButtonText: '<i class="fas fa-sign-out-alt"></i> Log out',
                cancelButtonText: "Cancel",
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: "Logging out...",
                        background: "#1e1e1e",
                        color: "#fff",
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                            setTimeout(() => (window.location.href = logoutUrl), 600);
                        },
                    });
                }
            });
        });

        // =======================================
        // 🧠 BLOCK BACK BUTTON CACHE
        // =======================================
        if (window.history && window.history.pushState) {
            window.history.pushState(null, null, window.location.href);
            window.onpopstate = function () {
                window.history.pushState(null, null, window.location.href);
            };
        }
        window.addEventListener("pageshow", function (event) {
            if (event.persisted || performance.getEntriesByType("navigation")[0].type === "back_forward") {
                window.location.href = "{% url 'index' %}";
            }
        });
    </script>

        <!-- ✅ AUTO REFRESH UPCOMING EVENTS EVERY 60s -->
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const refreshInterval = 60000; // 60 seconds
        let refreshTimer = null;

        async function refreshUpcomingEvents() {
            const section = document.getElementById("upcoming-events-section");
            if (!section) return;

            // Only refresh if on dashboard
            const activeNav = document.querySelector(".sidebar-nav .nav-item.active");
            if (!activeNav || !activeNav.textContent.includes("Dashboard")) return;

            try {
                const response = await fetch("{% url 'admin_dashboard' %}?is_ajax=true", { cache: "no-store" });
                if (!response.ok) throw new Error("Failed to refresh events");
                const html = await response.text();

                const tempDiv = document.createElement("div");
                tempDiv.innerHTML = html;
                const newSection = tempDiv.querySelector("#upcoming-events-section");

                if (newSection) {
                    section.innerHTML = newSection.innerHTML;
                    console.log("✅ Upcoming events auto-refreshed:", new Date().toLocaleTimeString());
                }
            } catch (err) {
                console.warn("⚠️ Event refresh failed:", err.message);
            }
        }

        // Start auto-refresh
        refreshTimer = setInterval(refreshUpcomingEvents, refreshInterval);
    });
    </script>

</body>
</html>