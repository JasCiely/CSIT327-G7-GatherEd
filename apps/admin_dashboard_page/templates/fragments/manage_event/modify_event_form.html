{% load static %}
<style>
    /* -------------------------------------- */
    /* CSS for Form inside Modal */
    /* -------------------------------------- */

    /* Inherited Variables (good practice to keep in case) */
    :root {
        --primary-color: #00A9FF;
        --success-color: #4CAF50;
        --danger-color: #F44336;
        --background-light: #1E1E1E;
        --background-dark: #121212;
        --text-light: #E0E0E0;
        --text-muted: #9E9E9E;
        --border-color: #333333;
    }

    /* --- MODAL SPECIFIC STYLES (REQUIRED FOR SPINNER) --- */
    .custom-modal-backdrop {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex; justify-content: center; align-items: center; z-index: 1000;
    }
    .custom-modal-content {
        background-color: var(--background-dark); color: var(--text-light);
        border: 1px solid var(--border-color); border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 169, 255, 0.2);
        width: 90%; max-width: 450px; padding: 30px; text-align: center;
        animation: fadeIn 0.3s ease-out;
    }
    .loading-modal-style {
        max-width: 300px; padding: 40px 30px; border-color: var(--primary-color);
    }
    .loading-modal-style h3 { margin-bottom: 25px; }
    .loading-spinner {
        font-size: 2rem; color: var(--primary-color); animation: spin 1.2s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    /* ---------------------------------------------------- */

    .modal-title-bar {
        padding: 20px 30px; border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
        background-color: var(--background-light);
    }
    .modal-title-bar h2 { margin: 0; color: var(--text-light); font-size: 1.5rem; }

    .form-content-wrapper { padding: 30px; background-color: var(--background-dark); }

    .edit-form-layout { display: flex; gap: 30px; flex-wrap: wrap; }
    .form-column { flex: 1; min-width: 280px; }

    /* General Input Styling */
    .form-column input:not([type="checkbox"]), .form-column textarea {
        background: var(--background-light);
        color: var(--text-light); border: 1px solid var(--border-color);
        width: 100%; padding: 10px; border-radius: 6px; box-sizing: border-box;
    }
    .form-column label { display: block; margin-top: 15px; margin-bottom: 5px; color: var(--text-light); }

    /* ðŸŽ¯ CRITICAL FIX: Two-Column Grid for Time fields only */
    .time-group-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 15px;
    }

    /* New: Style the container for Date, Start Time, and End Time */
    .schedule-field {
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .schedule-field label {
        margin-top: 0;
        margin-bottom: 5px;
        font-size: 0.9em;
        white-space: nowrap;
    }

    /* The Date field will take up its own row, creating vertical separation */
    .date-field-container {
        margin-top: 15px;
    }

    /* Responsive adjustment for small modals/screens */
    @media (max-width: 600px) {
        .edit-form-layout {
             flex-direction: column;
        }
        .time-group-row {
            grid-template-columns: 1fr;
        }
    }

    .form-actions {
        display: flex; gap: 15px; justify-content: flex-end;
        padding: 20px 30px; border-top: 1px solid var(--border-color);
        margin-top: 20px;
        background-color: var(--background-light);
    }
    .btn-cancel-event {
        background-color: var(--border-color); color: var(--text-light);
        padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none;
        transition: background-color 0.2s;
    }
    .btn-cancel-event:hover { background-color: #555555; }

    .btn-save-event {
        background-color: var(--success-color); color: white;
        padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none;
        transition: background-color 0.2s;
    }
    .btn-save-event:hover { background-color: #388e3c; }

    .modal-close-btn {
        background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 1.5rem;
        transition: color 0.2s;
    }
    .modal-close-btn:hover { color: var(--danger-color); }
</style>


<div class="modal-title-bar">
    <h2>Editing: {{ event.title }}</h2>
    <button type="button" class="modal-close-btn" title="Close Form">
        <i class="fas fa-times"></i>
    </button>
</div>

<div class="form-content-wrapper">
    <form id="edit-event-form-{{ event.id }}"
          method="POST"
          action="{% url 'modify_event_root' event_id=event.id %}"
          onsubmit="handleEditFormSubmit(event, this)">
        {% csrf_token %}

        <div class="edit-form-layout">
            <div class="form-column column-left">
                <h3>Basic Information</h3>

                <label for="event-title">Event Title</label>
                <input type="text" id="event-title" name="title" value="{{ event.title }}" required>

                <label for="event-description">Description</label>
                <textarea id="event-description" name="description" rows="4" required>{{ event.description }}</textarea>

                <label for="event-location">Location/Venue</label>
                <input type="text" id="event-location" name="location" value="{{ event.location }}" placeholder="e.g., Auditorium or Online Link">

            </div>

            <div class="form-column column-right">
                <h3>Logistics & Schedule</h3>

                <label for="max-attendees">Max Attendees (0 for unlimited)</label>
                <input type="number" id="max-attendees" name="max_attendees" value="{{ event.max_attendees|default:0 }}" placeholder="0 for unlimited" min="0">

                <div class="date-field-container schedule-field">
                    <label for="event-date">Date</label>
                    <input type="date" id="event-date" name="date" value="{{ current_date }}" required>
                </div>

                <div class="time-group-row">
                    <div class="schedule-field">
                        <label for="event-start-time">Start Time</label>
                        <input type="time" id="event-start-time" name="start_time" value="{{ current_start_time }}" required>
                    </div>
                    <div class="schedule-field">
                        <label for="event-end-time">End Time (Optional)</label>
                        <input type="time" id="event-end-time" name="end_time" value="{{ current_end_time }}">
                    </div>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="button" class="btn-cancel-event">
                <i class="fas fa-arrow-left"></i> Cancel
            </button>

            <button type="submit" id="save-event-btn" class="btn-save-event">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </form>
</div>

<script>
// --- MODAL UTILITY FUNCTIONS (Defined here to ensure scope) ---
function showLoadingModal(message) {
    $('#custom-loading-modal').remove();
    // This uses the custom CSS defined above
    const modalHtml = `<div id="custom-loading-modal" class="custom-modal-backdrop"><div class="custom-modal-content loading-modal-style"><h3>${message}</h3><i class="fas fa-sync-alt loading-spinner"></i></div></div>`;
    $('body').append(modalHtml);
}

function hideLoadingModal() {
    $('#custom-loading-modal').remove();
}

function showSuccessModal(message) {
    // Re-defining this here for completeness, though it is often in the parent script
    const modalHtml = `<div id="custom-success-modal" class="custom-modal-backdrop"><div class="custom-modal-content success-modal-style"><div class="modal-header"><i class="fas fa-check-circle success-icon"></i><h3>Success!</h3></div><p class="modal-body-text">${message}</p><div class="modal-actions"><button class="btn-modal-close">Close</button></div></div></div>`;
    $('body').append(modalHtml);
    $('#custom-success-modal').find('.btn-modal-close').on('click', function() {
        $('#custom-success-modal').remove();
    });
}
// ---------------------------------------------------------------


// Get the Django CSRF token from the cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Attach close handlers to the modal's buttons
$(document).ready(function() {
    $('.modal-close-btn, .btn-cancel-event').on('click', function() {
        $('#custom-form-modal').remove();
    });
});


// This function handles the POST submission for the update.
function handleEditFormSubmit(e, form) {
    e.preventDefault();

    const $form = $(form);
    const formData = $form.serialize();
    const actionUrl = $form.attr('action') + '?is_ajax=true';

    // ðŸš€ SHOW LOADING SPINNER
    showLoadingModal('Saving Event Changes...');

    $.ajax({
        url: actionUrl,
        method: 'POST',
        data: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            // ðŸ›‘ HIDE LOADING SPINNER
            hideLoadingModal();

            if (response.success) {
                $('#custom-form-modal').remove();

                showSuccessModal('Event details successfully updated!');

                // Logic to update the table row (critical for good UX)
                const updatedData = response.updated_data;
                const eventId = updatedData.id;
                const $row = $(`.clickable-row[data-event-id="${eventId}"]`);
                if ($row.length) {
                    $row.find('td[data-label="Event Name"]').text(updatedData.name);
                    $row.find('td[data-label="Date"]').text(updatedData.date);
                    $row.find('td[data-label="Registrations"]').text(updatedData.registrations);

                    const $statusCell = $row.find('td[data-label="Status"]');
                    $statusCell.removeClass().addClass(`status-${updatedData.status.toLowerCase()}`);
                    $statusCell.text(updatedData.status);

                    // Trigger a re-load of the details panel to show fresh data
                    $row.trigger('click');
                }
            } else {
                 // Error handling for server-side validation failure
                 if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: "Update Failed",
                        text: response.error || "Please check form fields and try again.",
                        icon: "error",
                        background: "#1e1e1e",
                        color: "#fff",
                        confirmButtonColor: "#00A9FF",
                    });
                } else {
                    alert("Update Failed: " + (response.error || "Please check form fields and try again."));
                }
            }
        },
        error: function(xhr) {
            // ðŸ›‘ HIDE LOADING SPINNER
            hideLoadingModal();

            // Error handling for network or server issues (e.g., 500 status)
            let errorMsg = xhr.responseText || `Server Error: Status ${xhr.status}`;
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    title: "Network Error",
                    text: 'Failed to save changes. ' + errorMsg,
                    icon: "error",
                    background: "#1e1e1e",
                    color: "#fff",
                    confirmButtonColor: "#00A9FF",
                });
            } else {
                alert('Network Error: Failed to save changes. ' + errorMsg);
            }
        }
    });
}
</script>