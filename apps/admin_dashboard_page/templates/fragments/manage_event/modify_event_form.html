{% load static %}

<style>
/* -------------------------------------- */
/* CSS for Form inside Modal */
/* -------------------------------------- */

:root {
    --primary-color: #00A9FF;
    --success-color: #4CAF50;
    --danger-color: #F44336;
    --background-light: #1E1E1E;
    --background-dark: #121212;
    --text-light: #E0E0E0;
    --text-muted: #9E9E9E;
    --border-color: #333333;
    --modal-bg: #282828;
}

.custom-modal-backdrop {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex; justify-content: center; align-items: center; z-index: 1000;
}

.custom-modal-content {
    background-color: var(--background-dark);
    color: var(--text-light);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 169, 255, 0.2);
    width: 90%; max-width: 450px; padding: 30px; text-align: center;
    animation: fadeIn 0.3s ease-out;
}

.loading-modal-style {
    max-width: 300px; padding: 40px 30px; border-color: var(--primary-color);
}
.loading-modal-style h3 { margin-bottom: 25px; }

.loading-spinner {
    font-size: 2rem;
    color: var(--primary-color);
    animation: spin 1.2s linear infinite;
}

@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(-20px);} to { opacity: 1; transform: translateY(0);} }

.swal2-popup {
    background: var(--modal-bg) !important;
    border: 1px solid var(--danger-color);
    box-shadow: 0 0 10px rgba(244, 67, 54, 0.5) !important;
}

.swal2-title, .swal2-html-container {
    color: var(--text-light) !important;
}

.swal2-icon.swal2-error {
    border-color: var(--danger-color) !important;
    color: var(--danger-color) !important;
}

.swal2-confirm {
    background-color: var(--primary-color) !important;
    color: white !important;
    border-radius: 6px !important;
    font-weight: 600 !important;
    padding: 10px 20px !important;
}

.modal-title-bar {
    padding: 20px 30px; border-bottom: 1px solid var(--border-color);
    display: flex; justify-content: space-between; align-items: center;
    background-color: var(--background-light);
}

.modal-title-bar h2 {
    margin: 0; color: var(--text-light); font-size: 1.5rem;
}

.form-content-wrapper { padding: 30px; background-color: var(--background-dark); }
.edit-form-layout { display: flex; gap: 30px; flex-wrap: wrap; }
.form-column { flex: 1; min-width: 280px; }

.form-column input:not([type="checkbox"]),
.form-column textarea,
.form-column select {
    background: var(--background-light);
    color: var(--text-light);
    border: 1px solid var(--border-color);
    width: 100%; padding: 10px;
    border-radius: 6px; box-sizing: border-box;
}

.form-column label {
    display: block; margin-top: 15px; margin-bottom: 5px; color: var(--text-light);
}

.time-group-row {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 20px; margin-top: 15px;
}

.manual-close-datetime-group {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 20px; margin-top: 10px;
}

.disabled-message {
    background-color: var(--danger-color);
    color: white; padding: 8px;
    border-radius: 6px; margin-top: 10px;
    font-size: 0.9em; text-align: center;
}

.form-actions {
    display: flex; gap: 15px; justify-content: flex-end;
    padding: 20px 30px; border-top: 1px solid var(--border-color);
    margin-top: 20px;
    background-color: var(--background-light);
}

.btn-cancel-event {
    background-color: var(--border-color); color: var(--text-light);
    padding: 10px 20px; border-radius: 6px;
    font-weight: 600; cursor: pointer; border: none;
}

.btn-save-event {
    background-color: var(--success-color); color: white;
    padding: 10px 20px; border-radius: 6px;
    font-weight: 600; cursor: pointer; border: none;
}

.modal-close-btn {
    background: none; border: none; cursor: pointer;
    color: var(--text-muted); font-size: 1.5rem;
}
</style>

<!-- ===================================================== -->
<!-- MODAL TITLE BAR -->
<!-- ===================================================== -->
<div class="modal-title-bar">
    <h2>Editing: {{ event.title }}</h2>
    <button type="button" class="modal-close-btn">
        <i class="fas fa-times"></i>
    </button>
</div>

<!-- ===================================================== -->
<!-- FORM CONTENT -->
<!-- ===================================================== -->
<div class="form-content-wrapper">

<form id="edit-event-form-{{ event.id }}"
      method="POST"
      enctype="multipart/form-data"
      action="{% url 'modify_event_root' event_id=event.id %}"
      onsubmit="handleEditFormSubmit(event, this)">
    {% csrf_token %}

    <div class="edit-form-layout">
        <div class="form-column column-left">

            <h3>Basic Information</h3>

            <label>Event Title</label>
            <input type="text" name="title" value="{{ event.title }}" required>

            <label>Description</label>
            <textarea name="description" rows="4" required>{{ event.description }}</textarea>

            <label>Event Image</label>
            <input type="file" name="image" accept="image/*" onchange="previewEventImage(this)">
            <div id="event-image-preview" style="margin-top:10px;">
                {% if event.image %}
                    <img id="preview-img" src="{{ event.image.url }}" style="max-width:100%;border-radius:8px;">
                {% endif %}
            </div>

            <label>Location / Venue</label>
            <input type="text" name="location" value="{{ event.location }}">
        </div>

        <div class="form-column column-right">
            <h3>Logistics & Schedule</h3>

            <label>Max Attendees</label>
            <input type="number" name="max_attendees" value="{{ event.max_attendees|default:0 }}" min="0">

            <label>Date</label>
            <input type="date" name="date" value="{{ current_date }}" required>

            <div class="time-group-row">
                <div>
                    <label>Start Time</label>
                    <input type="time" name="start_time" value="{{ current_start_time }}" required>
                </div>
                <div>
                    <label>End Time</label>
                    <input type="time" name="end_time" value="{{ current_end_time }}">
                </div>
            </div>

            <label>Registration Status Override</label>
            <select name="manual_status_override">
                <option value="OPEN_MANUAL" {% if event.manual_status_override == 'OPEN_MANUAL' %}selected{% endif %}>Registration Open</option>
                <option value="CLOSED_MANUAL" {% if event.manual_status_override == 'CLOSED_MANUAL' %}selected{% endif %}>Registration Closed</option>
                <option value="ONGOING" {% if event.manual_status_override == 'ONGOING' %}selected{% endif %}>Event Ongoing</option>
                <option value="AUTO" {% if not event.manual_status_override or event.manual_status_override == 'AUTO' %}selected{% endif %}>Automatic</option>
            </select>

            <div id="manual-time-limit-container" style="display:block;">
                <label>Override Date & Time</label>
                <div class="manual-close-datetime-group">
                    <input type="date" name="manual_close_date" value="{{ current_manual_close_date }}">
                    <input type="time" name="manual_close_time" value="{{ current_manual_close_time }}">
                </div>
            </div>
        </div>
    </div>

    <div class="form-actions">
        <button type="button" class="btn-cancel-event">Cancel</button>
        <button type="submit" class="btn-save-event" id="save-event-btn">Save Changes</button>
    </div>

</form>
</div>

<!-- ===================================================== -->
<!-- JS FUNCTIONS (NO ERRORS, ALL INCLUDED) -->
<!-- ===================================================== -->

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie) {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = cookie.substring(name.length + 1);
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<!-- IMAGE PREVIEW -->
<script>
function previewEventImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            let img = document.getElementById("preview-img");
            if (!img) {
                img = document.createElement("img");
                img.id = "preview-img";
                img.style.maxWidth = "100%";
                img.style.borderRadius = "8px";
                document.getElementById("event-image-preview").appendChild(img);
            }
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
}
</script>

<!-- SWEETALERT HELPERS -->
<script>
function showSuccessModal(msg) {
    Swal.fire({
        icon: "success",
        title: "Success!",
        text: msg,
        confirmButtonText: "OK"
    });
}

function showErrorAlert(title, msg) {
    Swal.fire({
        icon: "error",
        title: title,
        text: msg
    });
}

function showLoadingModal(msg) {
    Swal.fire({
        title: msg,
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
    });
}

function hideLoadingModal() { Swal.close(); }
</script>

<!-- AJAX SAVE -->
<script>
function handleEditFormSubmit(event, form) {
    event.preventDefault();

    const formData = new FormData(form);
    const url = form.action + "?is_ajax=true";

    showLoadingModal("Saving Changes...");

    $.ajax({
        url: url,
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        headers: { "X-CSRFToken": getCookie("csrftoken") },
        success: function(response) {
            hideLoadingModal();
            if (response.success) {
                showSuccessModal("Event updated successfully!");
                $("#custom-form-modal").remove();
            } else {
                showErrorAlert("Update Failed", response.error);
            }
        },
        error: function(xhr) {
            hideLoadingModal();
            showErrorAlert("Server Error", xhr.statusText);
        }
    });
}
</script>

