{% load static %}
<link rel="stylesheet" href="{% static 'css/manage_events_style.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="full-width-card manage-events-container">
    <div class="card-header">
        <h2>View and Modify Events</h2>
        <p class="card-subtitle">Manage all active, upcoming, and past events created across the schools.</p>
    </div>

    <div class="events-controls">
        <input id="search" type="text" placeholder="Search events by name..." class="control-input" onkeyup="filterTableByName()">
        <select id="statusFilter" class="control-select" onchange="filterTableByStatus(this.value)">
            <option value="all">All Statuses</option>
            <option value="active">Active</option>
            <option value="upcoming">Upcoming</option>
            <option value="completed">Completed</option>
        </select>
        <a href="javascript:void(0);"
           data-url="{% url 'create_event' %}?is_ajax=true"
           data-clean-url="{% url 'create_event' %}"
           class="btn btn-primary create-event-button"
           onclick="handleNavClick(this)">
            <i class="fas fa-plus"></i> New Event
        </a>
    </div>

    <div class="events-content-wrapper" style="display: flex; flex-direction: row; gap: 20px;">
        <div class="events-table-area">
            <div class="events-table-responsive">
                {% if events_list %}
                <table id="eventsTable" class="events-table">
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Date</th>
                            <th>Registrations</th>
                            <th>Event Status</th>
                            <th>Registration Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in events_list %}
                        <tr class="clickable-row" data-event-id="{{ event.id }}">
                            <td data-label="Event Name">{{ event.name }}</td>
                            <td data-label="Date">{{ event.date }}</td>
                            <td data-label="Registrations">{{ event.registrations }}</td>
                            <td data-label="Event Status" class="status status-{{ event.event_status|lower }}">{{ event.event_status }}</td>
                            <td data-label="Registration Status" class="status status-{{ event.registration_status|lower }}">{{ event.registration_status }}</td>
                            <td data-label="Actions" class="action-buttons">
                                <button class="btn-action delete delete-event-btn"
                                        title="Delete Event"
                                        data-event-id="{{ event.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div id="noResultsMessage" class="no-results-message" style="display: none;"></div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <p>No events found yet.</p>
                    <p class="muted">Start by creating your first event using the "New Event" button.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="event-details-panel">
            <div id="initial-details-message" class="details-placeholder" style="display: block;">
                <i class="fas fa-hand-pointer"></i>
                <h3>Select an Event</h3>
                <p>Click any row in the table to view the event's full details and management options here.</p>
            </div>

            <div id="event-details-content" style="display: none;"></div>
        </div>
    </div>
</div>

<script>
// Get the Django CSRF token from the cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// --- MODAL UTILITY FUNCTIONS ---
function showLoadingModal(message) {
    $('#custom-loading-modal').remove();
    const modalHtml = `<div id="custom-loading-modal" class="custom-modal-backdrop"><div class="custom-modal-content loading-modal-style"><h3>${message}</h3><i class="fas fa-sync-alt loading-spinner"></i></div></div>`;
    $('body').append(modalHtml);
}
function hideLoadingModal() { $('#custom-loading-modal').remove(); }

function showSuccessModal(message) {
    const modalHtml = `<div id="custom-success-modal" class="custom-modal-backdrop"><div class="custom-modal-content success-modal-style"><div class="modal-header"><i class="fas fa-check-circle success-icon"></i><h3>Success!</h3></div><p class="modal-body-text">${message}</p><div class="modal-actions"><button class="btn-modal-close">Close</button></div></div></div>`;
    $('body').append(modalHtml);
    $('#custom-success-modal').find('.btn-modal-close').on('click', function() { $('#custom-success-modal').remove(); });
}

function showDeleteConfirmationModal(eventName, onConfirm) {
    const modalHtml = `
        <div id="custom-delete-modal" class="custom-modal-backdrop">
            <div class="custom-modal-content delete-modal-style">
                <div class="modal-header">
                    <i class="fas fa-exclamation-triangle delete-icon"></i>
                    <h3>Confirm Event Deletion</h3>
                </div>
                <p class="modal-body-text">
                    Are you sure you want to permanently delete the event:
                    <br>
                    <strong>"${eventName}"</strong>?
                </p>
                <p class="modal-secondary-text">
                    This action cannot be undone. You will lose all associated data.
                </p>
                <div class="modal-actions">
                    <button class="btn-modal-cancel">Cancel</button>
                    <button class="btn-modal-delete">Yes, Delete Event</button>
                </div>
            </div>
        </div>
    `;
    $('body').append(modalHtml);
    const modal = $('#custom-delete-modal');
    modal.find('.btn-modal-cancel').on('click', function() { modal.remove(); });
    modal.find('.btn-modal-delete').on('click', function() { modal.remove(); onConfirm(); });
}

// --- URL HELPER FUNCTIONS ---
function getEventDetailsUrl(eventId) { return "{% url 'event_details_html' event_id='EVENT_ID_PLACEHOLDER' %}".replace('EVENT_ID_PLACEHOLDER', eventId); }
function getDeleteEventUrl(eventId) { return "{% url 'delete_event' event_id='EVENT_ID_PLACEHOLDER' %}".replace('EVENT_ID_PLACEHOLDER', eventId); }
function getModifyEventUrl(eventId) { return "{% url 'modify_event_root' event_id='EVENT_ID_PLACEHOLDER' %}".replace('EVENT_ID_PLACEHOLDER', eventId); }

// ðŸš€ FUNCTION TO LOAD AND RENDER THE EDIT FORM
function loadEditForm(eventId) {
    $('#custom-form-modal').remove();
    const $modal = $('<div id="custom-form-modal" class="custom-modal-backdrop"></div>');
    const $modalContent = $(`<div class="custom-modal-content" style="max-width: 700px; padding: 0; text-align: left;"></div>`);
    $modal.append($modalContent);
    $('body').append($modal);

    showLoadingModal('Loading Edit Form...');
    const url = getModifyEventUrl(eventId) + '?is_ajax=true';

    $.ajax({
        url: url,
        method: 'GET',
        headers: {'X-Requested-With': 'XMLHttpRequest'},
        success: function(response) {
            hideLoadingModal();
            if (response.success && response.html) {
                $modalContent.html(response.html);
                $modalContent.find('.modal-close-btn, .btn-cancel-event').on('click', function() { $('#custom-form-modal').remove(); });
            } else {
                $modalContent.html('<div class="error-message" style="padding: 30px; color:var(--danger-color);">Failed to load form: ' + (response.error || 'Unknown error') + '</div>');
            }
        },
        error: function(xhr) {
            hideLoadingModal();
            $modalContent.html(`<div class="error-message" style="padding: 30px; color:var(--danger-color);">Network Error: Could not fetch form (Status ${xhr.status}).</div>`);
        }
    });
}

// ðŸŽ¯ CONTROL FUNCTIONALITY: Search and Status Filter Logic
let currentSearchTerm = '';
let currentStatusFilter = 'all';

function applyCombinedFilter() {
    const $table = $('#eventsTable');
    if ($table.length === 0) return;
    const $rows = $table.find('tbody tr');
    let visibleCount = 0;

    $rows.each(function() {
        const $row = $(this);
        const nameText = $row.find('td[data-label="Event Name"]').text().toLowerCase();
        const statusText = $row.find('td[data-label="Event Status"]').text().toLowerCase().trim();
        const matchesSearch = nameText.includes(currentSearchTerm);
        const matchesStatus = currentStatusFilter === 'all' || statusText === currentStatusFilter;
        if (matchesSearch && matchesStatus) { $row.show(); visibleCount++; } else { $row.hide(); }
    });

    const $messageContainer = $('#noResultsMessage');
    const $tableElement = $('#eventsTable');
    if (visibleCount === 0 && ($rows.length > 0)) { $tableElement.hide(); $messageContainer.text("No events found matching your filter criteria.").show(); }
    else if (visibleCount > 0) { $tableElement.show(); $messageContainer.hide(); }
}

function filterTableByName() { currentSearchTerm = $('#search').val().toLowerCase().trim(); applyCombinedFilter(); }
function filterTableByStatus(value) { currentStatusFilter = value; applyCombinedFilter(); }

// --- DOCUMENT READY LOGIC ---
$(document).ready(function() {
    // Click row to view details
    $(document).on('click', '.clickable-row', function() {
        var eventId = $(this).data('event-id');
        $('#event-details-content').data('current-event-id', eventId);
        $('.clickable-row').removeClass('selected');
        $(this).addClass('selected');
        $('#initial-details-message').hide();
        var detailsContent = $('#event-details-content').show().html(`<p class="text-center" style="color: var(--text-muted); padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Loading details...</p>`);
        $.ajax({
            url: getEventDetailsUrl(eventId),
            method: 'GET',
            headers: {'X-Requested-With':'XMLHttpRequest'},
            success: function(data) {
                detailsContent.html(data);
                detailsContent.find('.full-edit-form-btn').off('click').on('click', function(e){ e.preventDefault(); e.stopPropagation(); loadEditForm($(this).data('event-id')); });
            },
            error: function(xhr) { detailsContent.html(`<div style="color: var(--danger-color); padding: 20px;">${xhr.responseText || `Error ${xhr.status}: Failed to load event details.`}</div>`); }
        });
    });

    // Delete button functionality (fixed)
    $(document).on('click', '.delete-event-btn', function(e) {
        e.preventDefault();
        e.stopPropagation(); // Prevent row click
        const eventId = $(this).data('event-id');
        const eventRow = $(this).closest('.clickable-row');
        const eventName = eventRow.find('td[data-label="Event Name"]').text();
        showDeleteConfirmationModal(eventName, function() {
            showLoadingModal('Deleting Event...');
            $.ajax({
                url: getDeleteEventUrl(eventId),
                method: 'DELETE',
                headers: {'X-Requested-With':'XMLHttpRequest','X-CSRFToken':csrftoken},
                success: function(response) {
                    hideLoadingModal();
                    if(response.success){
                        eventRow.fadeOut(300,function(){ $(this).remove(); applyCombinedFilter();
                            if($('#event-details-content').data('current-event-id')===eventId){
                                $('#event-details-content').hide().empty().removeData('current-event-id');
                                $('#initial-details-message').show();
                            }
                        });
                        showSuccessModal(`Event <strong>"${eventName}"</strong> has been successfully deleted.`);
                    } else { alert(`Error deleting event: ${response.error || 'Unknown error'}`); }
                },
                error: function(xhr){ hideLoadingModal(); alert(`Server Error: Failed to delete event. Status: ${xhr.status}`); }
            });
        });
    });

    window.filterTableByName = filterTableByName;
    window.filterTableByStatus = filterTableByStatus;
    window.loadEditForm = loadEditForm;
    applyCombinedFilter();
});
