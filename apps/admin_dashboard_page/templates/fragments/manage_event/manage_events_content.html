{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manage Events - GatherEd</title>

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap">
<link rel="stylesheet" href="{% static 'css/manage_event_css.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body, html { opacity: 1 !important; visibility: visible !important; }
#spinner, .loading-spinner { display: none !important; }
.row-selected { background-color: #e0f3ff; }
.clickable-row:hover { cursor: pointer; background-color: #f0f8ff; }
.full-width-card { opacity: 1 !important; visibility: visible !important; }
.details-placeholder { text-align: center; color: #666; padding: 40px; }
.error-text { color: red; }
</style>
</head>

<body>
<div class="full-width-card manage-events-container" data-fragment="manage_events">

    <div class="card-header">
        <h2>View and Modify Events</h2>
        <p class="card-subtitle">Manage all active, upcoming, and past events created across the schools.</p>
    </div>

    <div class="events-controls">
        <input type="text" placeholder="Search events by name..." class="control-input">
        <select class="control-select">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="upcoming">Upcoming</option>
            <option value="completed">Completed</option>
        </select>
        <a href="javascript:void(0);"
           data-url="{% url 'create_event' %}?is_ajax=true"
           data-clean-url="{% url 'create_event' %}"
           class="btn btn-primary create-event-button"
           onclick="handleNavClick(this)">
            <i class="fas fa-plus"></i> New Event
        </a>
    </div>

    <div class="events-content-wrapper" style="display: flex; flex-direction: row; gap: 20px;">
        <div class="events-table-area">
            <div class="events-table-responsive">
                {% if events_list %}
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Date</th>
                            <th>Registrations</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in events_list %}
                        <tr class="clickable-row" data-event-id="{{ event.id }}">
                            <td>{{ event.name }}</td>
                            <td>{{ event.date }}</td>
                            <td>{{ event.registrations }}</td>
                            <td class="status-{{ event.status|lower }}">{{ event.status }}</td>
                            <td class="action-buttons">
                                <button class="btn-action edit" title="Edit Event" onclick="event.stopPropagation()"><i class="fas fa-edit"></i></button>
                                <button class="btn-action delete" title="Delete Event" onclick="event.stopPropagation()"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <p>No events found yet.</p>
                    <p class="muted">Start by creating your first event using the "New Event" button.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="event-details-panel">
            <div id="initial-details-message" class="details-placeholder">
                <i class="fas fa-hand-pointer fa-2x"></i>
                <h3>Select an Event</h3>
                <p>Click any row in the table to view the event's full details and management options here.</p>
            </div>
            <div id="event-details-content" style="display: none;"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const detailsPanel = document.getElementById("event-details-content");
    const placeholder = document.getElementById("initial-details-message");
    let selectedRow = null;

    document.querySelectorAll(".clickable-row").forEach(row => {
        row.addEventListener("click", async (e) => {
            if (e.target.closest("button")) return;
            const eventId = row.dataset.eventId;

            if (selectedRow) selectedRow.classList.remove("row-selected");
            row.classList.add("row-selected");
            selectedRow = row;

            placeholder.style.display = "none";
            detailsPanel.style.display = "block";
            detailsPanel.scrollTop = 0;

            try {
                const res = await fetch(`/admin-dashboard/manage/events/event/${eventId}/details/?is_ajax=true`, { cache: "no-store" });
                if (!res.ok) throw new Error("Fetch failed");
                const html = await res.text();
                detailsPanel.innerHTML = html;
            } catch (err) {
                detailsPanel.innerHTML = `<p class="error-text">⚠️ Failed to load event details.</p>`;
            }
        });
    });
});
</script>
</body>
</html>