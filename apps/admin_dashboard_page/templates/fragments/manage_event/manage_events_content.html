{% load static %}

<!-- üîπ Redirect script: ensures hard refresh goes to admin dashboard -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const currentPath = window.location.pathname;
    if (currentPath === "/student_dashboard/manage/events/manage/events/") {
        window.location.replace("/admin_dashboard/");
    }
    sessionStorage.setItem("active_fragment", "manage_events");
});
</script>

<link rel="stylesheet" href="{% static 'css/manage_event_css.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<div class="full-width-card manage-events-container" data-fragment="manage_events">
    <!-- Card Header -->
    <div class="card-header">
        <h2>View and Modify Events</h2>
        <p class="card-subtitle">Manage all active, upcoming, and completed events created across the schools.</p>
    </div>

    <!-- Controls -->
    <div class="events-controls">
        <input id="search" type="text" placeholder="Search events by name..." class="control-input" onkeyup="filterTable()">
        <select id="statusFilter" class="control-select" onchange="applyFilter(this.value)">
            <option value="all">All Statuses</option>
            <option value="active">Active</option>
            <option value="upcoming">Upcoming</option>
            <option value="completed">Completed</option>
        </select>
        <a href="javascript:void(0);"
           data-url="{% url 'create_event' %}?is_ajax=true"
           data-clean-url="{% url 'create_event' %}"
           class="btn btn-primary create-event-button"
           onclick="handleNavClick(this)">
            <i class="fas fa-plus"></i> New Event
        </a>
    </div>

    <!-- Events Table & Details Panel -->
    <div class="events-content-wrapper" style="display: flex; flex-direction: row; gap: 20px;">
        <div class="events-table-area">
            <div class="events-table-responsive">
                {% if events_list %}
                <table id="eventsTable" class="events-table">
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Date</th>
                            <th>Registrations</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in events_list %}
                        <tr class="clickable-row" data-event-id="{{ event.id }}">
                            <td data-label="Event Name">{{ event.name }}</td>
                            <td data-label="Date">{{ event.date }}</td>
                            <td data-label="Registrations">{{ event.registrations }}</td>
                            <td data-label="Status" class="status">{{ event.status }}</td>
                            <td data-label="Actions" class="action-buttons">
                                <button class="btn-action edit" title="Edit Event" onclick="event.stopPropagation()"><i class="fas fa-edit"></i></button>
                                <button class="btn-action delete" title="Delete Event" onclick="event.stopPropagation()"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div id="noResultsMessage" class="no-results-message"></div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <p>No events found yet.</p>
                    <p class="muted">Start by creating your first event using the "New Event" button.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="event-details-panel">
            <div id="initial-details-message" class="details-placeholder">
                <i class="fas fa-hand-pointer"></i>
                <h3>Select an Event</h3>
                <p>Click any row in the table to view the event's full details and management options here.</p>
            </div>
            <div id="event-details-content" style="display: none;"></div>
        </div>
    </div>
</div>

<!-- JS: Search and Status Filter -->
<script>
function filterTable() {
    const input = document.getElementById("search").value.toLowerCase().trim();
    const rows = document.querySelectorAll("#eventsTable tbody tr");
    const messageContainer = document.getElementById("noResultsMessage");
    let visibleCount = 0;

    if (!input) {
        rows.forEach(row => row.style.display = "");
        messageContainer.textContent = "";
        applyFilter(document.getElementById("statusFilter").value);
        return;
    }

    try {
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            if (text.includes(input)) {
                row.style.display = "";
                visibleCount++;
            } else {
                row.style.display = "none";
            }
        });
        messageContainer.textContent = visibleCount === 0 ? "No results found." : "";
    } catch (error) {
        console.error("Filter error:", error);
        messageContainer.textContent = "Something went wrong. Please try again.";
    }
}

function applyFilter(value) {
    const validFilters = ["all", "active", "upcoming", "completed"];
    const rows = document.querySelectorAll("#eventsTable tbody tr");
    const messageContainer = document.getElementById("noResultsMessage");
    let visibleCount = 0;

    if (!validFilters.includes(value)) {
        messageContainer.textContent = "Invalid filter ignored. Showing default results.";
        filterTable();
        return;
    }

    rows.forEach(row => {
        const statusCell = row.querySelector(".status");
        const status = statusCell ? statusCell.textContent.toLowerCase() : "";

        if (value === "all" || status === value) {
            row.style.display = "";
            visibleCount++;
        } else {
            row.style.display = "none";
        }
    });

    const searchText = document.getElementById("search").value.toLowerCase().trim();
    if (searchText) filterTable(); // reapply text filter on top of status filter

    messageContainer.textContent = visibleCount === 0 ? "No results found." : "";
}
</script>

<!-- JS: Initialize clickable rows -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const detailsPanel = document.getElementById("event-details-content");
    const placeholder = document.getElementById("initial-details-message");

    function initRows() {
        document.querySelectorAll(".clickable-row").forEach(row => {
            row.addEventListener("click", () => {
                const eventId = row.dataset.eventId;
                placeholder.style.display = "none";
                detailsPanel.style.display = "block";
                detailsPanel.innerHTML = `
                    <div class="loading-event-details">
                        <div class="spinner-border text-primary" role="status"></div>
                        <span>Loading event details...</span>
                    </div>
                `;
                fetch(`/admin-dashboard/event/${eventId}/details/?is_ajax=true`, { cache: "no-store" })
                    .then(res => res.ok ? res.text() : Promise.reject("Failed to fetch"))
                    .then(html => detailsPanel.innerHTML = html)
                    .catch(() => detailsPanel.innerHTML = `<p class="error-text">‚ö†Ô∏è Failed to load event details.</p>`);
            });
        });
    }
    initRows();

    if (!performance.getEntriesByType("navigation")[0].type.includes("reload")) return;
    const activeFragment = sessionStorage.getItem("active_fragment");
    if (activeFragment === "manage_events") {
        window.location.replace("/admin_dashboard/?reload_fragment=manage_events");
    }
});
</script>
