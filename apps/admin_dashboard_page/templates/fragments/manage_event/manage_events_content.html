{% load static %}
<style>
/* -------------------------------------- */
/* üöÄ CSS STYLES (Provided by User) */
/* -------------------------------------- */

:root {
    --primary-color: #00A9FF;
    --secondary-color: #7B68EE;
    --success-color: #4CAF50;
    --danger-color: #F44336;
    --warning-color: #FFC107;
    --background-light: #1E1E1E;
    --background-dark: #121212;
    --text-light: #E0E0E0;
    --text-muted: #9E9E9E;
    --border-color: #333333;
    --accent-blue-rgba: rgba(0, 169, 255, 0.6);
    --panel-background: #191919;
}

.manage-events-container {
    background-color: var(--background-light);
    border: 1px solid var(--border-color);
}

.card-header h2 { color: var(--text-light); }
.card-subtitle { color: var(--text-muted); }

.events-controls {
    display: flex; gap: 15px; margin-bottom: 25px; align-items: center; flex-wrap: wrap;
}

.control-input, .control-select {
    padding: 10px 12px; border-radius: 6px; border: 1px solid var(--border-color);
    background: var(--background-dark); color: var(--text-light); font-size: 0.95rem;
}

.control-input { flex-grow: 1; min-width: 200px; }

.btn-primary {
    background-color: var(--primary-color); color: var(--background-dark);
    padding: 10px 15px; border-radius: 6px; text-decoration: none; font-weight: 600;
    transition: background-color 0.2s; white-space: nowrap;
}

.btn-primary:hover { background-color: #007bb5; }

.events-table-responsive { overflow-x: auto; }

.events-table {
    width: 100%; border-collapse: collapse; margin-top: 15px; min-width: 700px;
}

.events-table th, .events-table td {
    padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color);
    color: var(--text-light);
}

.events-table th {
    background-color: var(--primary-color) !important;
    color: var(--background-dark) !important;
    font-weight: 700; text-transform: uppercase; font-size: 0.9rem;
}

.events-table tbody tr { background-color: var(--background-light); }

/* Standard hover effect */
.events-table tbody tr:hover { background-color: #252525; }

/* Status Badges */
.status-active { color: var(--success-color); font-weight: 600; }
.status-upcoming { color: var(--warning-color); font-weight: 600; }
.status-completed { color: var(--text-muted); }

/* Action Buttons */
.action-buttons { white-space: nowrap; }

.btn-action {
    background: none; border: none; cursor: pointer; font-size: 1rem;
    margin-right: 5px; padding: 5px; transition: color 0.2s;
}

.btn-action.delete { color: var(--danger-color); }
.btn-action.delete:hover { color: #cc0000; }

/* Empty State */
.empty-state {
    text-align: center; padding: 80px 20px; color: var(--text-muted);
}
.empty-state i { font-size: 40px; margin-bottom: 15px; display: block; }

/* FLEX LAYOUT & PANEL STYLES */
.events-content-wrapper {
    margin-top: 20px; align-items: stretch !important; min-height: 400px;
}

.events-table-area { flex: 2; min-width: 0; }

.event-details-panel {
    flex: 1; min-width: 300px; max-width: 400px;
    background-color: var(--panel-background) !important;
    border: 3px solid var(--primary-color) !important;
    border-radius: 12px; padding: 0 !important;
    box-shadow: 0 5px 25px var(--accent-blue-rgba);
    color: var(--text-light);
    position: sticky; top: 20px;
    height: 100% !important;
}

.details-placeholder {
    width: 100% !important; height: 100% !important; margin: 0 !important;
    display: flex !important; flex-direction: column !important;
    justify-content: center !important; align-items: center !important;
    padding: 20px 15px !important;
    background-color: var(--background-light) !important;
    border-radius: 12px;
    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.7) !important;
    text-align: center !important;
}

.details-placeholder i {
    font-size: 4rem; color: var(--primary-color) !important; margin-bottom: 20px;
    text-shadow: 0 0 15px var(--accent-blue-rgba) !important;
    animation: pulse-icon 2s infinite alternate;
}

@keyframes pulse-icon {
    from { opacity: 0.8; transform: scale(1); }
    to { opacity: 1; transform: scale(1.02); }
}

/* Responsive adjustment */
@media (max-width: 1000px) {
    .events-content-wrapper { flex-direction: column !important; min-height: auto; }
    .events-table-area, .event-details-panel { flex: auto; max-width: none; min-width: auto; position: static; }
    .details-placeholder { height: 250px; }
}

/* ‚≠ê‚≠ê‚≠ê CORRECTED SELECTED ROW INDICATION CSS ‚≠ê‚≠ê‚≠ê */
.events-table tbody .clickable-row.selected {
    /* Use a color slightly darker than the hover, but with the primary accent */
    background-color: #253343;

    /* Prominent left border using the main primary color */
    border-left: 5px solid var(--primary-color);

    /* Subtle glow/shadow effect to lift it */
    box-shadow: inset 0 0 10px var(--accent-blue-rgba);

    /* Slight scale for visual pop */
    transform: scale(1.005);
    transition: all 0.2s ease-in-out;
}

/* Ensure the text color is bright and clear when selected */
.events-table tbody .clickable-row.selected td {
    color: var(--text-light) !important;
    font-weight: 500;
}

/* Ensure selected rows don't change color on hover (to avoid flicker) */
.events-table tbody .clickable-row.selected:hover {
    background-color: #253343; /* Keep the selected color */
}
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="full-width-card manage-events-container">
    <div class="card-header">
        <h2>View and Modify Events</h2>
        <p class="card-subtitle">Manage all active, upcoming, and past events created across the schools.</p>
    </div>

    <div class="events-controls">
        <input type="text" placeholder="Search events by name..." class="control-input">
        <select class="control-select">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="upcoming">Upcoming</option>
            <option value="completed">Completed</option>
        </select>
        <a href="javascript:void(0);"
           data-url="{% url 'create_event' %}?is_ajax=true"
           data-clean-url="{% url 'create_event' %}"
           class="btn btn-primary create-event-button"
           onclick="handleNavClick(this)">
            <i class="fas fa-plus"></i> New Event
        </a>
    </div>

    <div class="events-content-wrapper" style="display: flex; flex-direction: row; gap: 20px;">
        <div class="events-table-area">
            <div class="events-table-responsive">
                {% if events_list %}
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Date</th>
                            <th>Registrations</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in events_list %}
                        <tr class="clickable-row" data-event-id="{{ event.id }}">
                            <td data-label="Event Name">{{ event.name }}</td>
                            <td data-label="Date">{{ event.date }}</td>
                            <td data-label="Registrations">{{ event.registrations }}</td>
                            <td data-label="Status" class="status-{{ event.status|lower }}">{{ event.status }}</td>
                            <td data-label="Actions" class="action-buttons">
                                <button class="btn-action delete" title="Delete Event" onclick="event.stopPropagation()">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <p>No events found yet.</p>
                    <p class="muted">Start by creating your first event using the "New Event" button.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="event-details-panel">
            <div id="initial-details-message" class="details-placeholder" style="display: block;">
                <i class="fas fa-hand-pointer"></i>
                <h3>Select an Event</h3>
                <p>Click any row in the table to view the event's full details and management options here.</p>
            </div>

            <div id="event-details-content" style="display: none;"></div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    console.log("Manage Events Script: Initializing AJAX event delegation.");

    // Generate correct URL for event details respecting Django URL patterns
    function getEventDetailsUrl(eventId) {
        return "{% url 'event_details_html' 'EVENT_ID_PLACEHOLDER' %}".replace('EVENT_ID_PLACEHOLDER', eventId);
    }

    // Click handler for rows
    $(document).on('click', '.clickable-row', function() {
        var eventId = $(this).data('event-id');
        var detailsUrl = getEventDetailsUrl(eventId);

        console.log("Event row clicked. ID:", eventId, "URL:", detailsUrl);

        // üéØ HIGHLIGHT LOGIC: Remove 'selected' from all, add it to the clicked row
        $('.clickable-row').removeClass('selected');
        $(this).addClass('selected');

        // Hide placeholder and show loading spinner
        $('#initial-details-message').hide();
        var detailsContent = $('#event-details-content').show().html(
            `<p class="text-center" style="color: var(--text-muted); padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i> Loading details...
            </p>`
        );

        // AJAX call
        $.ajax({
            url: detailsUrl,
            method: 'GET',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(data) {
                console.log("AJAX Success. Details loaded.");
                detailsContent.html(data);
            },
            error: function(xhr) {
                let errorMsg = xhr.responseText || `Error ${xhr.status}: Failed to load event details.`;
                detailsContent.html(`<div style="color: var(--danger-color); padding: 20px;">${errorMsg}</div>`);
                console.error("AJAX Error details:", xhr.responseText);
            }
        });
    });
});
</script>