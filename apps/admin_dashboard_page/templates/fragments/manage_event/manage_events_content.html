{% load static %}
<style>
/* -------------------------------------- */
/* ðŸš€ CSS STYLES (Base Theme) */
/* -------------------------------------- */

:root {
    --primary-color: #00A9FF;
    --secondary-color: #7B68EE;
    --success-color: #4CAF50;
    --danger-color: #F44336;
    --warning-color: #FFC107;
    --background-light: #1E1E1E;
    --background-dark: #121212;
    --text-light: #E0E0E0;
    --text-muted: #9E9E9E;
    --border-color: #333333;
    --accent-blue-rgba: rgba(0, 169, 255, 0.6);
    --panel-background: #191919;
}

.manage-events-container {
    background-color: var(--background-light);
    border: 1px solid var(--border-color);
}

.card-header h2 { color: var(--text-light); }
.card-subtitle { color: var(--text-muted); }

.events-controls {
    display: flex; gap: 15px; margin-bottom: 25px; align-items: center; flex-wrap: wrap;
}

.control-input, .control-select {
    padding: 10px 12px; border-radius: 6px; border: 1px solid var(--border-color);
    background: var(--background-dark); color: var(--text-light); font-size: 0.95rem;
}

.control-input { flex-grow: 1; min-width: 200px; }

.btn-primary {
    background-color: var(--primary-color); color: var(--background-dark);
    padding: 10px 15px; border-radius: 6px; text-decoration: none; font-weight: 600;
    transition: background-color 0.2s; white-space: nowrap;
}

.btn-primary:hover { background-color: #007bb5; }

.events-table-responsive { overflow-x: auto; }

.events-table {
    width: 100%; border-collapse: collapse; margin-top: 15px; min-width: 700px;
}

.events-table th, .events-table td {
    padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color);
    color: var(--text-light);
}

.events-table th {
    background-color: var(--primary-color) !important;
    color: var(--background-dark) !important;
    font-weight: 700; text-transform: uppercase; font-size: 0.9rem;
}

.events-table tbody tr { background-color: var(--background-light); }
.events-table tbody tr:hover { background-color: #252525; }

/* Status Badges */
.status-active { color: var(--success-color); font-weight: 600; }
.status-upcoming { color: var(--warning-color); font-weight: 600; }
.status-completed { color: var(--text-muted); }

/* Action Buttons */
.action-buttons { white-space: nowrap; }

.btn-action {
    background: none; border: none; cursor: pointer; font-size: 1rem;
    margin-right: 5px; padding: 5px; transition: color 0.2s;
}

.btn-action.delete { color: var(--danger-color); }
.btn-action.delete:hover { color: #cc0000; }
.btn-action.edit { color: var(--primary-color); }
.btn-action.edit:hover { color: #007bb5; }


/* Empty State */
.empty-state {
    text-align: center; padding: 80px 20px; color: var(--text-muted);
}
.empty-state i { font-size: 40px; margin-bottom: 15px; display: block; }

/* FLEX LAYOUT & PANEL STYLES */
.events-content-wrapper {
    margin-top: 20px; align-items: stretch !important; min-height: 400px;
}

.events-table-area { flex: 2; min-width: 0; }

.event-details-panel {
    flex: 1; min-width: 300px; max-width: 400px;
    background-color: var(--panel-background) !important;
    border: 3px solid var(--primary-color) !important;
    border-radius: 12px; padding: 0 !important;
    box-shadow: 0 5px 25px var(--accent-blue-rgba);
    color: var(--text-light);
    position: sticky; top: 20px;
    height: 100% !important;
}

.details-placeholder {
    width: 100% !important; height: 100% !important; margin: 0 !important;
    display: flex !important; flex-direction: column !important;
    justify-content: center !important; align-items: center !important;
    padding: 20px 15px !important;
    background-color: var(--background-light) !important;
    border-radius: 12px;
    box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.7) !important;
    text-align: center !important;
}

.details-placeholder i {
    font-size: 4rem; color: var(--primary-color) !important; margin-bottom: 20px;
    text-shadow: 0 0 15px var(--accent-blue-rgba) !important;
    animation: pulse-icon 2s infinite alternate;
}

@keyframes pulse-icon {
    from { opacity: 0.8; transform: scale(1); }
    to { opacity: 1; transform: scale(1.02); }
}

/* Responsive adjustment */
@media (max-width: 1000px) {
    .events-content-wrapper { flex-direction: column !important; min-height: auto; }
    .events-table-area, .event-details-panel { flex: auto; max-width: none; min-width: auto; position: static; }
    .details-placeholder { height: 250px; }
}

/* SELECTED ROW INDICATION */
.events-table tbody .clickable-row.selected {
    background-color: #253343;
    border-left: 5px solid var(--primary-color);
    box-shadow: inset 0 0 10px var(--accent-blue-rgba);
    transform: scale(1.005);
    transition: all 0.2s ease-in-out;
}
.events-table tbody .clickable-row.selected td {
    color: var(--text-light) !important;
    font-weight: 500;
}
.events-table tbody .clickable-row.selected:hover {
    background-color: #253343;
}

/* -------------------------------------- */
/* âš¡ MODAL STYLES (Delete, Success, Loading, and Form) */
/* -------------------------------------- */

/* Backdrop */
.custom-modal-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

/* Modal Box - Base Style */
.custom-modal-content {
    background-color: var(--background-dark);
    color: var(--text-light);
    border: 1px solid var(--border-color);
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 169, 255, 0.2);
    width: 90%;
    max-width: 450px;
    padding: 30px;
    text-align: center;
    animation: fadeIn 0.3s ease-out;
}

/* Header/Icon */
.modal-header {
    margin-bottom: 20px;
}

.modal-header i {
    font-size: 3rem;
    margin-bottom: 15px;
}

.custom-modal-content h3 {
    color: var(--text-light);
    font-size: 1.5rem;
    margin: 0;
}

/* Body Text */
.modal-body-text {
    font-size: 1.1rem;
    color: var(--text-light);
    margin-bottom: 10px;
}

.modal-body-text strong {
    color: var(--warning-color);
    font-weight: 700;
}

.modal-secondary-text {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-bottom: 30px;
}

/* Actions */
.modal-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
}

.modal-actions button {
    padding: 10px 20px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: background-color 0.2s;
}

/* ðŸŸ¢ SUCCESS MODAL STYLES */
.custom-modal-content.success-modal-style {
    border: 1px solid var(--success-color);
    box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
}

.success-icon {
    color: var(--success-color) !important;
}

.btn-modal-close {
    background-color: var(--success-color) !important;
    color: white !important;
}

.btn-modal-close:hover {
    background-color: #388e3c !important;
}

/* ðŸ”´ DELETE MODAL ENHANCED STYLES */
.custom-modal-content.delete-modal-style {
    border: 1px solid var(--danger-color);
    box-shadow: 0 4px 20px rgba(244, 67, 54, 0.4);
}

.delete-icon {
    color: var(--danger-color) !important;
}

.btn-modal-cancel {
    background-color: var(--border-color);
    color: var(--text-light);
}
.btn-modal-cancel:hover {
    background-color: #555555;
}
.btn-modal-delete {
    background-color: var(--danger-color);
    color: white;
}
.btn-modal-delete:hover {
    background-color: #cc0000;
}

/* ðŸŒ€ LOADING MODAL SPECIFIC STYLES */
.custom-modal-content.loading-modal-style {
    max-width: 300px;
    padding: 40px 30px;
    border-color: var(--primary-color);
}

.loading-modal-style h3 {
    margin-bottom: 25px;
}

.loading-spinner {
    font-size: 2rem;
    color: var(--primary-color);
    animation: spin 1.2s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* No results message */
.no-results-message {
    text-align: center;
    padding: 20px;
    color: var(--warning-color);
    font-size: 1.1rem;
    font-weight: 600;
}

</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="full-width-card manage-events-container">
    <div class="card-header">
        <h2>View and Modify Events</h2>
        <p class="card-subtitle">Manage all active, upcoming, and past events created across the schools.</p>
    </div>

    <div class="events-controls">
        <input id="search" type="text" placeholder="Search events by name..." class="control-input" onkeyup="filterTableByName()">
        <select id="statusFilter" class="control-select" onchange="filterTableByStatus(this.value)">
            <option value="all">All Statuses</option>
            <option value="active">Active</option>
            <option value="upcoming">Upcoming</option>
            <option value="completed">Completed</option>
        </select>
        <a href="javascript:void(0);"
           data-url="{% url 'create_event' %}?is_ajax=true"
           data-clean-url="{% url 'create_event' %}"
           class="btn btn-primary create-event-button"
           onclick="handleNavClick(this)">
            <i class="fas fa-plus"></i> New Event
        </a>
    </div>

    <div class="events-content-wrapper" style="display: flex; flex-direction: row; gap: 20px;">
        <div class="events-table-area">
            <div class="events-table-responsive">
                {% if events_list %}
                <table id="eventsTable" class="events-table">
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Date</th>
                            <th>Registrations</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for event in events_list %}
                        <tr class="clickable-row" data-event-id="{{ event.id }}">
                            <td data-label="Event Name">{{ event.name }}</td>
                            <td data-label="Date">{{ event.date }}</td>
                            <td data-label="Registrations">{{ event.registrations }}</td>
                            <td data-label="Status" class="status status-{{ event.status|lower }}">{{ event.status }}</td>
                            <td data-label="Actions" class="action-buttons">
                                <button class="btn-action delete delete-event-btn"
                                        title="Delete Event"
                                        data-event-id="{{ event.id }}"
                                        **onclick="event.stopPropagation()"**>
                                    <i class="fas fa-trash"></i>
                                </button>
                                </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div id="noResultsMessage" class="no-results-message" style="display: none;"></div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-calendar-times"></i>
                    <p>No events found yet.</p>
                    <p class="muted">Start by creating your first event using the "New Event" button.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <div class="event-details-panel">
            <div id="initial-details-message" class="details-placeholder" style="display: block;">
                <i class="fas fa-hand-pointer"></i>
                <h3>Select an Event</h3>
                <p>Click any row in the table to view the event's full details and management options here.</p>
            </div>

            <div id="event-details-content" style="display: none;"></div>
        </div>
    </div>
</div>

<script>
// Get the Django CSRF token from the cookie
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');


// --- MODAL UTILITY FUNCTIONS ---
function showLoadingModal(message) {
    $('#custom-loading-modal').remove();
    const modalHtml = `<div id="custom-loading-modal" class="custom-modal-backdrop"><div class="custom-modal-content loading-modal-style"><h3>${message}</h3><i class="fas fa-sync-alt loading-spinner"></i></div></div>`;
    $('body').append(modalHtml);
}

function hideLoadingModal() {
    $('#custom-loading-modal').remove();
}

function showSuccessModal(message) {
    const modalHtml = `<div id="custom-success-modal" class="custom-modal-backdrop"><div class="custom-modal-content success-modal-style"><div class="modal-header"><i class="fas fa-check-circle success-icon"></i><h3>Success!</h3></div><p class="modal-body-text">${message}</p><div class="modal-actions"><button class="btn-modal-close">Close</button></div></div></div>`;
    $('body').append(modalHtml);
    $('#custom-success-modal').find('.btn-modal-close').on('click', function() {
        $('#custom-success-modal').remove();
    });
}

function showDeleteConfirmationModal(eventName, onConfirm) {
    const modalHtml = `
            <div id="custom-delete-modal" class="custom-modal-backdrop">
                <div class="custom-modal-content delete-modal-style">
                    <div class="modal-header">
                        <i class="fas fa-exclamation-triangle delete-icon"></i>
                        <h3>Confirm Event Deletion</h3>
                    </div>
                    <p class="modal-body-text">
                        Are you sure you want to permanently delete the event:
                        <br>
                        <strong>"${eventName}"</strong>?
                    </p>
                    <p class="modal-secondary-text">
                        This action cannot be undone. You will lose all associated data.
                    </p>
                    <div class="modal-actions">
                        <button class="btn-modal-cancel">Cancel</button>
                        <button class="btn-modal-delete">Yes, Delete Event</button>
                    </div>
                </div>
            </div>
        `;
    $('body').append(modalHtml);
    const modal = $('#custom-delete-modal');
    modal.find('.btn-modal-cancel').on('click', function() { modal.remove(); });
    modal.find('.btn-modal-delete').on('click', function() { modal.remove(); onConfirm(); });
}


// --- URL HELPER FUNCTIONS (Uses Django URL template tags) ---

function getEventDetailsUrl(eventId) {
    // Uses the 'event_details_html' name from your urls.py
    return "{% url 'event_details_html' event_id='EVENT_ID_PLACEHOLDER' %}".replace('EVENT_ID_PLACEHOLDER', eventId);
}

function getDeleteEventUrl(eventId) {
    // Uses the 'delete_event' name from your urls.py
    return "{% url 'delete_event' event_id='EVENT_ID_PLACEHOLDER' %}".replace('EVENT_ID_PLACEHOLDER', eventId);
}

function getModifyEventUrl(eventId) {
    // Uses the 'modify_event_root' name from your urls.py
    return "{% url 'modify_event_root' event_id='EVENT_ID_PLACEHOLDER' %}".replace('EVENT_ID_PLACEHOLDER', eventId);
}


// ðŸš€ FUNCTION TO LOAD AND RENDER THE EDIT FORM
function loadEditForm(eventId) {
    // 1. Remove any existing modal instance to ensure a clean load
    $('#custom-form-modal').remove();

    // 2. Create the base modal structure
    const $modal = $('<div id="custom-form-modal" class="custom-modal-backdrop"></div>');
    const $modalContent = $(`<div class="custom-modal-content" style="max-width: 700px; padding: 0; text-align: left;"></div>`);

    $modal.append($modalContent);
    $('body').append($modal);

    showLoadingModal('Loading Edit Form...');

    const url = getModifyEventUrl(eventId) + '?is_ajax=true';

    $.ajax({
        url: url,
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            hideLoadingModal();

            if (response.success && response.html) {
                // *** ðŸŽ¯ Render the HTML string returned by the server-side view ***
                $modalContent.html(response.html);

                // Add event listener for the close/cancel buttons inside the form
                $modalContent.find('.modal-close-btn, .btn-cancel-event').on('click', function() {
                    $('#custom-form-modal').remove();
                });

            } else {
                $modalContent.html('<div class="error-message" style="padding: 30px; color:var(--danger-color);">Failed to load form: ' + (response.error || 'Unknown error') + '</div>');
            }
        },
        error: function(xhr) {
            hideLoadingModal();
            $modalContent.html(`<div class="error-message" style="padding: 30px; color:var(--danger-color);">Network Error: Could not fetch form (Status ${xhr.status}).</div>`);
        }
    });
}
// -------------------------------------------------------------

// -------------------------------------------------------------
// ðŸŽ¯ CONTROL FUNCTIONALITY: Search and Status Filter Logic
// -------------------------------------------------------------

let currentSearchTerm = '';
let currentStatusFilter = 'all';

function applyCombinedFilter() {
    const $table = $('#eventsTable');
    if ($table.length === 0) return;

    const $rows = $table.find('tbody tr');
    let visibleCount = 0;

    $rows.each(function() {
        const $row = $(this);
        const nameText = $row.find('td[data-label="Event Name"]').text().toLowerCase();
        const statusText = $row.find('td[data-label="Status"]').text().toLowerCase().trim();

        const matchesSearch = nameText.includes(currentSearchTerm);
        const matchesStatus = currentStatusFilter === 'all' || statusText === currentStatusFilter;

        if (matchesSearch && matchesStatus) {
            $row.show();
            visibleCount++;
        } else {
            $row.hide();
        }
    });

    const $messageContainer = $('#noResultsMessage');
    const $tableElement = $('#eventsTable');

    if (visibleCount === 0 && ($rows.length > 0)) {
        $tableElement.hide();
        $messageContainer.text("No events found matching your filter criteria.").show();
    } else if (visibleCount > 0) {
        $tableElement.show();
        $messageContainer.hide();
    }
}

function filterTableByName() {
    currentSearchTerm = $('#search').val().toLowerCase().trim();
    applyCombinedFilter();
}

function filterTableByStatus(value) {
    currentStatusFilter = value;
    applyCombinedFilter();
}


// --- DOCUMENT READY LOGIC ---
$(document).ready(function() {

    // --- ROW CLICK HANDLER (View Details) ---
    $(document).on('click', '.clickable-row', function() {
        var eventId = $(this).data('event-id');
        var detailsUrl = getEventDetailsUrl(eventId);

        $('#event-details-content').data('current-event-id', eventId);

        $('.clickable-row').removeClass('selected');
        $(this).addClass('selected');

        $('#initial-details-message').hide();
        var detailsContent = $('#event-details-content').show().html(
            `<p class="text-center" style="color: var(--text-muted); padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i> Loading details...
            </p>`
        );

        $.ajax({
            url: detailsUrl,
            method: 'GET',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            success: function(data) {
                detailsContent.html(data);

                // This is the handler for the Edit button *inside* the details panel (if present)
                detailsContent.find('.full-edit-form-btn').off('click').on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const eventId = $(this).data('event-id');
                    loadEditForm(eventId);
                });
            },
            error: function(xhr) {
                let errorMsg = xhr.responseText || `Error ${xhr.status}: Failed to load event details.`;
                detailsContent.html(`<div style="color: var(--danger-color); padding: 20px;">${errorMsg}</div>`);
            }
        });
    });

    // ðŸ”´ DELETE BUTTON HANDLER (Functional via event.stopPropagation() in HTML)
    $(document).on('click', '.delete-event-btn', function(e) {
        e.preventDefault();
        // **event.stopPropagation() is handled in the HTML, ensuring the row click doesn't fire.**

        const eventId = $(this).data('event-id');
        const eventRow = $(this).closest('.clickable-row');
        const eventName = eventRow.find('td[data-label="Event Name"]').text();

        showDeleteConfirmationModal(eventName, function() {

            const deleteUrl = getDeleteEventUrl(eventId);
            showLoadingModal('Deleting Event...');

            $.ajax({
                url: deleteUrl,
                method: 'DELETE',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrftoken
                },
                success: function(response) {
                    hideLoadingModal();

                    if (response.success) {
                        eventRow.fadeOut(300, function() {
                            $(this).remove();
                            applyCombinedFilter(); // Re-apply filter after deletion

                            if ($('#event-details-content').data('current-event-id') === eventId) {
                                $('#event-details-content').hide().empty().removeData('current-event-id');
                                $('#initial-details-message').show();
                            }
                        });

                        showSuccessModal(`Event <strong>"${eventName}"</strong> has been successfully deleted.`);

                    } else {
                        alert(`Error deleting event: ${response.error || 'Unknown error'}`);
                    }
                },
                error: function(xhr) {
                    hideLoadingModal();
                    console.error("AJAX Delete Error:", xhr.responseText);
                    alert(`Server Error: Failed to delete event. Status: ${xhr.status}`);
                }
            });
        });
    });

    // ðŸŸ¢ EDIT BUTTON HANDLER (Functional via event.stopPropagation() in HTML - not currently in the provided HTML but kept for reference)
    $(document).on('click', '.edit-event-btn', function(e) {
        e.preventDefault();
        // e.stopPropagation() is in the HTML, calling loadEditForm directly.

        const eventId = $(this).data('event-id');
        // loadEditForm(eventId) is typically called directly from the HTML click attribute for buttons *other* than this JQuery handler.
    });


    // Expose filter functions globally
    window.filterTableByName = filterTableByName;
    window.filterTableByStatus = filterTableByStatus;
    window.loadEditForm = loadEditForm; // Expose the function globally

    // Run the filter on load
    applyCombinedFilter();
});
</script>