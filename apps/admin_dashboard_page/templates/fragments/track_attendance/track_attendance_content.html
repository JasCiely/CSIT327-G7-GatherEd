{% load static %}
<link rel="stylesheet" href="{% static 'css/track_attendance_css.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% csrf_token %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="full-width-card attendance-container">
    <div class="card-header">
        <h2><i class="fas fa-clipboard-list"></i> Event Attendance Recorder</h2>
        <p class="card-subtitle">Select an event to mark attendance. <strong>Unrecorded students are prioritized at the top.</strong></p>
    </div>

    <div class="attendance-controls">
        <label for="event-select" class="control-label">
            <i class="fas fa-calendar-alt"></i> Select Event:
        </label>
        <select id="event-select" class="control-select">
            <option value="">-- Choose an Event --</option>
            {% for event in events_list %}
            <option value="{{ event.id }}" data-status="{{ event.status|default:'SCHEDULED' }}">{{ event.title }}</option>
            {% endfor %}
        </select>
    </div>

    <div id="status-control-message" class="alert-message hidden"></div>

    <div id="attendance-list-area">
        <div id="loading-message" class="hidden">
            <div class="loading-spinner"></div>
            <p>Loading student list...</p>
        </div>

        <div id="no-event-message" class="empty-state">
            <i class="fas fa-clipboard-check"></i>
            <p>Please select an event to load the registration list.</p>
        </div>

        <h3 id="unrecorded-header" class="attendance-section-header hidden">
            <i class="fas fa-users"></i> Unrecorded Students
            <span id="unrecorded-count" class="count-badge"></span>
        </h3>
        <table id="unrecorded-table" class="attendance-table hidden">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>ID / Email</th>
                    <th class="status-col">Current Status</th>
                    <th class="action-col">Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3 id="recorded-header" class="attendance-section-header hidden">
            <i class="fas fa-user-check"></i> Recorded Students
            <span id="recorded-count" class="count-badge"></span>
        </h3>
        <table id="recorded-table" class="attendance-table hidden">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>ID / Email</th>
                    <th class="status-col">Current Status</th>
                    <th class="action-col">Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
$(document).ready(function() {
    const eventSelect = $('#event-select');
    const unrecordedTable = $('#unrecorded-table');
    const recordedTable = $('#recorded-table');
    const unrecordedHeader = $('#unrecorded-header');
    const recordedHeader = $('#recorded-header');
    const unrecordedCount = $('#unrecorded-count');
    const recordedCount = $('#recorded-count');
    const loadingMessage = $('#loading-message');
    const noEventMessage = $('#no-event-message');
    const statusControlMessage = $('#status-control-message');

    let isAttendanceEnabled = false;

    // --- CSRF Token Retrieval ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
            if (cookieValue !== null && cookieValue !== '') {
                return cookieValue;
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- Utility Functions ---
    function updateSectionVisibility() {
        const unCount = unrecordedTable.find('tbody tr').length;
        const recCount = recordedTable.find('tbody tr').length;

        // Update count badges
        unrecordedCount.text(`(${unCount})`);
        recordedCount.text(`(${recCount})`);

        // Hide headers/tables if they are empty
        unrecordedHeader.toggleClass('hidden', unCount === 0);
        unrecordedTable.toggleClass('hidden', unCount === 0);
        recordedHeader.toggleClass('hidden', recCount === 0);
        recordedTable.toggleClass('hidden', recCount === 0);
    }

    function generateRowHtml(student) {
        // student.status will be 'Present', 'Absent', or 'Unmarked' from the Django view
        const isPresent = student.status === 'Present';
        // If current status is 'Present', the button action is to 'Mark Absent' (X)
        const icon = isPresent ? 'fa-times' : 'fa-check';
        const btnClass = isPresent ? 'present' : '';
        const btnText = isPresent ? ' Absent' : ' Present';

        // Status icon mapping
        let statusIcon = 'fa-question-circle';
        if (student.status === 'Present') statusIcon = 'fa-check-circle';
        else if (student.status === 'Absent') statusIcon = 'fa-times-circle';
        else if (student.status === 'Cancelled') statusIcon = 'fa-ban';

        return `
            <tr data-student-id="${student.student_id}" data-recorded="${student.is_recorded}">
                <td>${student.name}</td>
                <td>${student.identifier}</td>
                <td class="status-col">
                    <div class="current-status ${student.status}">
                        <i class="fas ${statusIcon}"></i>
                        ${student.status}
                    </div>
                </td>
                <td class="action-col">
                    <button class="btn-mark-status ${btnClass}" data-status="${student.status}" data-student-id="${student.student_id}" ${isAttendanceEnabled ? '' : 'disabled'}>
                        <i class="fas ${icon}"></i>${btnText}
                    </button>
                </td>
            </tr>`;
    }

    // --- Main Data Loading Function ---
    function updateAttendanceDisplay(eventId) {
        unrecordedTable.find('tbody').empty();
        recordedTable.find('tbody').empty();
        isAttendanceEnabled = false;

        noEventMessage.addClass('hidden');
        loadingMessage.removeClass('hidden');
        statusControlMessage.addClass('hidden').removeClass('warning-notice error-notice success-notice').text('');
        updateSectionVisibility();

        if (!eventId) {
            loadingMessage.addClass('hidden');
            noEventMessage.removeClass('hidden').html(`
                <i class="fas fa-clipboard-check"></i>
                <p>Please select an event to load the registration list.</p>
            `);
            return;
        }

        $.ajax({
            url: `api/get-students/${eventId}/`, // Assumes a Django path structure
            method: 'GET',
            success: function(response) {
                loadingMessage.addClass('hidden');
                noEventMessage.addClass('hidden'); // Ensure hidden on successful load

                const students = response.students;
                isAttendanceEnabled = response.attendance_enabled;

                if (!isAttendanceEnabled) {
                    // Display attendance control message (e.g., event not started)
                    statusControlMessage.html('<i class="fas fa-exclamation-triangle"></i> ' + response.status_message).removeClass('hidden').addClass('warning-notice');
                }

                if (students.length === 0) {
                    // This block ensures the "No students" message is only shown when the list is truly empty.
                    noEventMessage.removeClass('hidden').html(`
                        <i class="fas fa-user-slash"></i>
                        <p>NOTICE: There are no students registered for this event.</p>
                    `);
                    updateSectionVisibility();
                    return;
                }

                const unFragment = document.createDocumentFragment();
                const recFragment = document.createDocumentFragment();

                // Populate fragments based on recorded status
                students.forEach(student => {
                    // The row is constructed here, using the current isAttendanceEnabled status
                    const row = $(generateRowHtml(student))[0];
                    if (student.is_recorded) recFragment.appendChild(row);
                    else unFragment.appendChild(row);
                });

                unrecordedTable.find('tbody').append(unFragment);
                recordedTable.find('tbody').append(recFragment);

                // Disable buttons globally if attendance is not enabled
                if (!isAttendanceEnabled) $('.btn-mark-status').prop('disabled', true);

                updateSectionVisibility();
            },
            error: function(xhr) {
                loadingMessage.addClass('hidden');
                // Display error message
                const err = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to load student list.';
                noEventMessage.removeClass('hidden').html(`
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Error: ${err}</p>
                `);
                updateSectionVisibility();
            }
        });
    }

    // --- Event Handlers ---
    eventSelect.on('change', function() {
        const selectedEventId = $(this).val();
        updateAttendanceDisplay(selectedEventId);
    });

    $('#attendance-list-area').on('click', '.btn-mark-status', function() {
        const button = $(this);
        // Pre-check if attendance is allowed
        if (!isAttendanceEnabled) {
            alert('Attendance cannot be recorded at this time. ' + statusControlMessage.text().replace('⚠️ ', ''));
            return;
        }

        const row = button.closest('tr');
        const eventId = eventSelect.val();
        if (!eventId) return alert("Please select an event first.");

        const studentId = row.data('student-id');
        const currentStatus = button.data('status');
        const wasUnmarked = currentStatus === 'Unmarked'; // Check if we are moving from unrecorded to recorded

        // Determine the status for the *next* action. If current status is 'Present', the next action is to 'Mark Absent'.
        const newStatus = currentStatus === 'Present' ? 'Absent' : 'Present';

        button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Updating...');

        $.ajax({
            url: 'api/record-attendance/', // Assumes a Django path structure
            method: 'POST',
            // Send boolean to Django view. True means ATTENDED/Present, False means ABSENT/Absent.
            data: { student_id: studentId, event_id: eventId, is_present: newStatus === 'Present' },
            headers: { 'X-CSRFToken': csrftoken },
            success: function(resp) {
                button.prop('disabled', false);

                // resp.new_status will be 'Present' or 'Absent' from the server (using map_db_status_to_js)

                // 1. Update status cell
                const statusCell = row.find('.current-status');
                const statusIcon = resp.new_status === 'Present' ? 'fa-check-circle' : 'fa-times-circle';
                statusCell.removeClass('Present Absent Unmarked').addClass(resp.new_status)
                    .html(`<i class="fas ${statusIcon}"></i> ${resp.new_status}`);

                // 2. Update button state for next click
                button.data('status', resp.new_status);
                // If the new status is Present, the button should now show 'Absent' (for the next toggle)
                if (resp.new_status === 'Present') {
                    button.addClass('present').html('<i class="fas fa-times"></i> Absent');
                } else {
                    // If the new status is Absent, the button should now show 'Present' (for the next toggle)
                    button.removeClass('present').html('<i class="fas fa-check"></i> Present');
                }

                // 3. Move row if it was previously Unmarked
                if (wasUnmarked) {
                    row.data('recorded', true);
                    // Move the row to the recorded table
                    row.appendTo(recordedTable.find('tbody'));
                    updateSectionVisibility();
                }
            },
            error: function(xhr) {
                button.prop('disabled', false);
                const err = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to save attendance.';
                alert('Error saving attendance: ' + err);

                // Reset button to previous state
                if (currentStatus === 'Present') {
                    button.addClass('present').html('<i class="fas fa-times"></i> Absent');
                } else {
                    button.removeClass('present').html('<i class="fas fa-check"></i> Present');
                }
            }
        });
    });
});
</script>