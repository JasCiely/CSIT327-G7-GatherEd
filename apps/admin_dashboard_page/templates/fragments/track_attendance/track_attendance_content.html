{% load static %}
<link rel="stylesheet" href="{% static 'css/track_attendance_css.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% csrf_token %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
    /* Status Message Styling */
    .alert-message {
        padding: 12px;
        margin-top: 15px;
        border-radius: 4px;
        font-weight: bold;
        text-align: center;
        border: 1px solid transparent;
    }
    .alert-message.error-notice {
        background-color: #fce4e4;
        color: #c70000;
        border-color: #fcc;
    }
    .alert-message.success-notice {
        background-color: #e6f7e9;
        color: #1a6435;
        border-color: #cfd;
    }
    .alert-message.warning-notice {
        background-color: #fff8e1;
        color: #b37300;
        border-color: #ffe;
    }

    .btn-mark-status:hover:not(:disabled) {
        background-color: #0056b3;
    }
    .btn-mark-status.present:hover:not(:disabled) {
        background-color: #bd2130;
    }
    .btn-mark-status:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }

    #loading-message, #no-event-message {
        text-align: center;
        padding: 15px;
        font-style: italic;
        color: #777;
    }
</style>

<div class="full-width-card attendance-container">
    <div class="card-header">
        <h2>Event Attendance Recorder üìã</h2>
        <p class="card-subtitle">Select an event to mark attendance. **Unrecorded** students are prioritized at the top.</p>
    </div>

    <div class="attendance-controls">
        <label for="event-select" class="control-label">Select Event:</label>
        <select id="event-select" class="control-select">
            <option value="">-- Choose an Event --</option>
            {% for event in events_list %}
            <option value="{{ event.id }}" data-status="{{ event.status|default:'SCHEDULED' }}">{{ event.title }}</option>
            {% endfor %}
        </select>
    </div>

    <div id="status-control-message" class="alert-message hidden"></div>

    <div id="attendance-list-area">
        <p id="loading-message" class="hidden">Loading student list...</p>
        <p id="no-event-message">Please select an event to load the registration list.</p>

        <h3 id="unrecorded-header" class="attendance-section-header hidden">Unrecorded Students (Unmarked)</h3>
        <table id="unrecorded-table" class="attendance-table hidden">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>ID / Email</th>
                    <th class="status-col">Current Status</th>
                    <th class="action-col">Mark</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3 id="recorded-header" class="attendance-section-header hidden">Recorded Students (Present/Absent)</h3>
        <table id="recorded-table" class="attendance-table hidden">
            <thead>
                <tr>
                    <th>Student Name</th>
                    <th>ID / Email</th>
                    <th class="status-col">Current Status</th>
                    <th class="action-col">Mark</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
$(document).ready(function() {
    const eventSelect = $('#event-select');
    const unrecordedTable = $('#unrecorded-table');
    const recordedTable = $('#recorded-table');
    const unrecordedHeader = $('#unrecorded-header');
    const recordedHeader = $('#recorded-header');
    const loadingMessage = $('#loading-message');
    const noEventMessage = $('#no-event-message');
    const statusControlMessage = $('#status-control-message');

    let isAttendanceEnabled = false;

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function updateSectionVisibility() {
        const unCount = unrecordedTable.find('tbody tr').length;
        const recCount = recordedTable.find('tbody tr').length;
        unrecordedHeader.toggleClass('hidden', unCount === 0);
        unrecordedTable.toggleClass('hidden', unCount === 0);
        recordedHeader.toggleClass('hidden', recCount === 0);
        recordedTable.toggleClass('hidden', recCount === 0);
    }

    function generateRowHtml(student) {
        const isPresent = student.status === 'Present';
        const icon = isPresent ? 'fa-times' : 'fa-check';
        const btnClass = isPresent ? 'present' : '';
        const btnText = isPresent ? ' Absent' : ' Present';
        return `
            <tr data-student-id="${student.student_id}" data-recorded="${student.is_recorded}">
                <td>${student.name}</td>
                <td>${student.identifier}</td>
                <td class="status-col current-status ${student.status}">${student.status}</td>
                <td class="action-col">
                    <button class="btn-mark-status ${btnClass}" data-status="${student.status}" data-student-id="${student.student_id}" ${isAttendanceEnabled ? '' : 'disabled'}>
                        <i class="fas ${icon}"></i>${btnText}
                    </button>
                </td>
            </tr>`;
    }

    function updateAttendanceDisplay(eventId) {
        unrecordedTable.find('tbody').empty();
        recordedTable.find('tbody').empty();
        isAttendanceEnabled = false;

        noEventMessage.addClass('hidden');
        loadingMessage.removeClass('hidden');
        statusControlMessage.addClass('hidden').removeClass('warning-notice error-notice success-notice').text('');
        updateSectionVisibility();

        if (!eventId) {
            loadingMessage.addClass('hidden');
            noEventMessage.text('Please select an event to load the registration list.').removeClass('hidden');
            return;
        }

        $.ajax({
            url: `api/get-students/${eventId}/`,
            method: 'GET',
            success: function(response) {
                loadingMessage.addClass('hidden');
                const students = response.students;
                isAttendanceEnabled = response.attendance_enabled;

                if (!isAttendanceEnabled) {
                    statusControlMessage.html('‚ö†Ô∏è ' + response.status_message).removeClass('hidden').addClass('warning-notice');
                }

                if (students.length === 0) {
                    noEventMessage.text('NOTICE: There are no students registered for this event.').removeClass('hidden');
                    updateSectionVisibility();
                    return;
                }

                const unFragment = document.createDocumentFragment();
                const recFragment = document.createDocumentFragment();

                students.forEach(student => {
                    const row = $(generateRowHtml(student))[0];
                    if (student.is_recorded) recFragment.appendChild(row);
                    else unFragment.appendChild(row);
                });

                unrecordedTable.find('tbody').append(unFragment);
                recordedTable.find('tbody').append(recFragment);

                if (!isAttendanceEnabled) $('.btn-mark-status').prop('disabled', true);
                updateSectionVisibility();
            },
            error: function(xhr) {
                loadingMessage.addClass('hidden');
                const err = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to load student list.';
                noEventMessage.text('Error: ' + err).removeClass('hidden').addClass('error-notice');
                updateSectionVisibility();
            }
        });
    }

    eventSelect.on('change', function() {
        const selectedEventId = $(this).val();
        updateAttendanceDisplay(selectedEventId);
    });

    $('#attendance-list-area').on('click', '.btn-mark-status', function() {
        const button = $(this);
        if (!isAttendanceEnabled) {
            alert('Attendance cannot be recorded at this time. ' + statusControlMessage.text().replace('‚ö†Ô∏è ', ''));
            return;
        }

        const row = button.closest('tr');
        const eventId = eventSelect.val();
        if (!eventId) return alert("Please select an event first.");

        const studentId = row.data('student-id');
        const currentStatus = button.data('status');
        const wasUnmarked = currentStatus === 'Unmarked';
        const newStatus = currentStatus === 'Present' ? 'Absent' : 'Present';

        button.prop('disabled', true).addClass('loading');

        $.ajax({
            url: 'api/record-attendance/',
            method: 'POST',
            data: { student_id: studentId, event_id: eventId, is_present: newStatus === 'Present' },
            headers: { 'X-CSRFToken': csrftoken },
            success: function(resp) {
                button.prop('disabled', false).removeClass('loading');
                const statusCell = row.find('.current-status');
                statusCell.removeClass('Present Absent Unmarked').addClass(resp.new_status).text(resp.new_status);
                button.data('status', resp.new_status);

                if (resp.new_status === 'Present') button.addClass('present').html('<i class="fas fa-times"></i> Absent');
                else button.removeClass('present').html('<i class="fas fa-check"></i> Present');

                if (wasUnmarked) {
                    row.data('recorded', true);
                    row.appendTo(recordedTable.find('tbody'));
                    updateSectionVisibility();
                }
            },
            error: function(xhr) {
                button.prop('disabled', false).removeClass('loading');
                const err = xhr.responseJSON ? xhr.responseJSON.error : 'Failed to save attendance.';
                alert('Error saving attendance: ' + err);
            }
        });
    });
});
</script>
