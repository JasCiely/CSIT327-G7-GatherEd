{% load static %}
<link rel="stylesheet" href="{% static 'css/manage_feedback_css.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

{# ------------------------------------------------------------------ #}
{# SELECT2 (Searchable Dropdown Library) LINKS #}
{# ------------------------------------------------------------------ #}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<div class="full-width-card feedback-container">
    <div class="card-header">
        <h2>Event Feedback and Reviews</h2>
        <p class="card-subtitle">Review feedback submissions, track ratings, and identify areas for improvement.</p>
    </div>

    {# --- FEEDBACK STATISTICS CARDS --- #}
    <div class="feedback-stats">
        <div class="stat-box">
            <p class="stat-label">Avg. Rating</p>
            <h3 class="stat-value primary-text"><i class="fas fa-star"></i> {{ avg_rating|default:"N/A" }}/5</h3>
        </div>
        <div class="stat-box">
            <p class="stat-label">Total Submissions</p>
            <h3 class="stat-value">{{ total_submissions|default:"0" }}</h3>
        </div>
        <div class="stat-box">
            <p class="stat-label">New Unread</p>
            <h3 class="stat-value attention-text">{{ new_feedback|default:"0" }}</h3>
        </div>
        <div class="stat-box">
            <p class="stat-label">Events Reviewed</p>
            <h3 class="stat-value secondary-text">{{ events_reviewed|default:"0" }}</h3>
        </div>
    </div>

    {# --- FILTER AND SORT BAR --- #}
    <div class="feedback-controls">
        <select id="event-filter" class="control-select">
            <option value="">All Events</option>
            {% for event in events_list %}
            <option value="{{ event.id }}">{{ event.title }}</option>
            {% empty %}
            {% endfor %}
        </select>
        <select id="sort-filter" class="control-select">
            <option value="date_desc">Sort by Date (Newest)</option>
            <option value="rating_desc">Sort by Rating (High)</option>
            <option value="rating_asc">Sort by Rating (Low)</option>
        </select>

        <button id="refresh-button" class="control-button btn-secondary"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>

    {# --- FEEDBACK LIST CONTAINER (This content will be updated by AJAX) --- #}
    <div id="feedback-list-container" class="feedback-list">
        {% if feedback_list %}
            {% for feedback in feedback_list %}
            {# Placeholder for future feedback rendering #}
            <div class="feedback-card">
                <p>Feedback card placeholder...</p>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <i class="fas fa-comments"></i>
                <p>No feedback submissions found yet.</p>
                <p class="muted">Start collecting reviews after your next event!</p>
            </div>
        {% endif %}
    </div>
</div>


{# ------------------------------------------------------------------ #}
{# JAVASCRIPT/JQUERY LOGIC to enable searchable dropdown and refresh #}
{# ------------------------------------------------------------------ #}
<script>
$(document).ready(function() {
    var eventFilter = $('#event-filter');
    var refreshButton = $('#refresh-button');
    var feedbackContainer = $('#feedback-list-container');
    var currentUrl = "{% url 'manage_feedback' %}";

    // 1. Initialize Select2 for searchable dropdown
    eventFilter.select2({
        placeholder: "Select an Event or Search...",
        allowClear: true
    });

    /**
     * Executes the AJAX call to refresh the feedback data based on current filters.
     */
    function loadFeedbackData() {
        // Get current filter and sort values
        var selectedEventId = eventFilter.val();
        var selectedSort = $('#sort-filter').val();

        // Build the query string for the Django view
        var queryParams = {
            'is_ajax': 'true',
            'event_id': selectedEventId,
            'sort_by': selectedSort
        };

        // Perform the AJAX request
        $.ajax({
            url: currentUrl,
            type: 'GET',
            data: queryParams,
            beforeSend: function() {
                // Show loading state
                refreshButton.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Loading');
                feedbackContainer.css('opacity', '0.5');
            },
            success: function(response) {
                // Replace the content of the feedback list container with the response
                feedbackContainer.html(response);
            },
            error: function(xhr, status, error) {
                console.error("Feedback refresh failed:", error);
                alert("Failed to refresh feedback data. Please try again.");
            },
            complete: function() {
                // Restore button and container state
                refreshButton.prop('disabled', false).html('<i class="fas fa-sync-alt"></i> Refresh');
                feedbackContainer.css('opacity', '1');

                // Re-initialize Select2 because the AJAX call replaces the entire fragment,
                // potentially destroying the Select2 element.
                eventFilter.select2({
                    placeholder: "Select an Event or Search...",
                    allowClear: true
                });
            }
        });
    }

    // 2. Attach handlers to trigger data refresh
    refreshButton.on('click', function(e) {
        e.preventDefault();
        loadFeedbackData();
    });

    eventFilter.on('change', function() {
        loadFeedbackData();
    });

    $('#sort-filter').on('change', function() {
        loadFeedbackData();
    });
});
</script>